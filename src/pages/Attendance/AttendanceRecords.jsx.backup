import { useState, useEffect } from 'react'
import axios from 'axios'
import { toast } from 'react-toastify'

const API_BASE_URL = 'http://localhost:3001'

export default function AttendanceRecords() {
  const [records, setRecords] = useState([])
  const [loading, setLoading] = useState(false)
  const [pagination, setPagination] = useState({ page: 1, limit: 20, total: 0 })
  const [filters, setFilters] = useState({
    start_date: '',
    end_date: ''
  })
  const [stats, setStats] = useState({
    total_days: 0,
    late_count: 0,
    early_count: 0,
    normal_count: 0
  })
  const [employee] = useState({ id: 1, user_id: 1, name: 'å¼ ä¸‰' })

  useEffect(() => {
    fetchRecords()
  }, [pagination.page, filters])

  const fetchRecords = async () => {
    setLoading(true)
    try {
      const response = await axios.get(`${API_BASE_URL}/api/attendance/records`, {
        params: {
          employee_id: employee.id,
          page: pagination.page,
          limit: pagination.limit,
          ...filters
        }
      })

      if (response.data.success) {
        setRecords(response.data.data)
        setPagination(prev => ({ ...prev, ...response.data.pagination }))

        // è®¡ç®—ç»Ÿè®¡æ•°æ®
        const stats = response.data.data.reduce((acc, record) => {
          acc.total_days++
          if (record.status === 'late') acc.late_count++
          if (record.status === 'early') acc.early_count++
          if (record.status === 'normal') acc.normal_count++
          return acc
        }, { total_days: 0, late_count: 0, early_count: 0, normal_count: 0 })
        setStats(stats)
      }
    } catch (error) {
      toast.error('è·å–æ‰“å¡è®°å½•å¤±è´¥')
    } finally {
      setLoading(false)
    }
  }

  const handleQuickFilter = (type) => {
    const today = new Date()
    let start_date, end_date

    switch (type) {
      case 'today':
        start_date = end_date = today.toISOString().split('T')[0]
        break
      case 'week':
        const weekStart = new Date(today)
        weekStart.setDate(today.getDate() - today.getDay() + 1)
        start_date = weekStart.toISOString().split('T')[0]
        end_date = today.toISOString().split('T')[0]
        break
      case 'month':
        start_date = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0]
        end_date = today.toISOString().split('T')[0]
        break
      default:
        start_date = end_date = ''
    }

    setFilters({ start_date, end_date })
    setPagination(prev => ({ ...prev, page: 1 }))
  }

  const formatDateTime = (dateTimeStr) => {
    if (!dateTimeStr) return '--:--'
    const date = new Date(dateTimeStr)
    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false })
  }

  const formatDate = (dateStr) => {
    const date = new Date(dateStr)
    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' })
  }

  const getStatusBadge = (status) => {
    const badges = {
      normal: { text: 'æ­£å¸¸', color: 'bg-green-100 text-green-800' },
      late: { text: 'è¿Ÿåˆ°', color: 'bg-red-100 text-red-800' },
      early: { text: 'æ—©é€€', color: 'bg-orange-100 text-orange-800' },
      absent: { text: 'ç¼ºå‹¤', color: 'bg-gray-100 text-gray-800' },
      leave: { text: 'è¯·å‡', color: 'bglue-100 text-blue-800' }
    }
    const badge = badges[status] || badges.normal
    return (
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${badge.color}`}>
        {badge.text}
      </span>
    )
  }

  return (
    <div className="p-6">
      {/* å¤´éƒ¨ */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-800">æ‰“å¡è®°å½•</h1>
        <p className="text-gray-600 mt-1">æŸ¥çœ‹æ‚¨çš„è€ƒå‹¤æ‰“å¡å†å²</p>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-600">æ€»å¤©æ•°</div>
          <div className="text-2xl font-bold text-gray-800 mt-1">{stats.total_days}</div>
        </div>
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-600">æ­£å¸¸</div>
          <div className="text-2xl font-bold text-green-600 mt-1">{stats.normal_count}</div>
        </div>
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-600">è¿Ÿåˆ°</div>
          <div className="text-2xl font-bold text-red-600 mt-1">{stats.late_count}</div>
        </div>
        <div className="bg-white rounded-lg shadow p-4">
          <div className="text-sm text-gray-600">æ—©é€€</div>
          <div className="text-2xl font-bold text-orange-600 mt-1">{stats.early_count}</div>
        </div>
      </div>

      {/* ç­›é€‰å™¨ */}
      <div className="bg-white rounded-lg shadow p-4 mb-6">
        <div className="flex flex-wrap gap-4 items-end">
          {/* å¿«æ·ç­›é€‰ */}
          <div className="flex gap-2">
            <button
              onClick={() => handleQuickFilter('today')}
              className="px-4 py-2 border rounded hover:bg-gray-50"
            >
              ä»Šå¤©
            </button>
            <button
              onClick={() => handleQuickFilter('week')}
              className="px-4 py-2 border rounded hover:bg-gray-50"
            >
              æœ¬å‘¨
            </button>
            <button
              onClick={() => handleQuickFilter('month')}
              className="px-4 py-2 border rounded hover:bg-gray-50"
            >
              æœ¬æœˆ
            </button>
            <button
              onClick={() => handleQuickFilter('all')}
              className="px-4 py-2 border rounded hover:bg-gray-50"
            >
              å…¨éƒ¨
            </button>
          </div>

          {/* æ—¥æœŸèŒƒå›´ */}
          <div className="flex gap-2 items-center">
            <input
              type="date"
              value={filters.start_date}
              onChange={(e) => setFilters(prev => ({ ...prev, start_date: e.target.value }))}
              className="border rounded px-3 py-2"
            />
            <span>è‡³</span>
            <input
              type="date"
              value={filters.end_date}
              onChange={(e) => setFilters(prev => ({ ...prev, end_date: e.target.value }))}
              className="border rounded px-3 py-2"
            />
          </div>
        </div>
      </div>

      {/* è®°å½•åˆ—è¡¨ */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        {loading ? (
          <div className="p-8 text-center text-gray-500">åŠ è½½ä¸­...</div>
        ) : records.length === 0 ? (
          <div className="p-8 text-center text-gray-500">æš‚æ— æ‰“å¡è®°å½•</div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ—¥æœŸ</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸Šç­æ‰“å¡</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸‹ç­æ‰“å¡</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å·¥ä½œæ—¶é•¿</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">çŠ¶æ€</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¤‡æ³¨</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {records.map((record) => (
                  <tr key={record.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {formatDate(record.record_date)}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                      <div>{formatDateTime(record.clock_in_time)}</div>
                      {record.clock_in_location && (
                        <div className="text-xs text-gray-500">ğŸ“ {record.clock_in_location}</div>
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                      <div>{formatDateTime(record.clock_out_time)}</div>
                      {record.clock_out_location && (
                        <div className="text-xs text-gray-500">ğŸ“ {record.clock_out_location}</div>
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                      {record.work_hours ? `${record.work_hours}h` : '--'}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      {getStatusBadge(record.status)}
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-500">
                      {record.remark || '--'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {/* åˆ†é¡µ */}
        {pagination.total > 0 && (
          <div className="px-6 py-4 border-t flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="text-sm text-gray-700">
                å…± {pagination.total} æ¡è®°å½•
              </div>
              <div className="flex items-center gap-2">
                <label className="text-sm text-gray-600">æ¯é¡µæ˜¾ç¤º</label>
                <select
                  value={pagination.limit}
                  onChange={(e) => setPagination({ ...pagination, limit: parseInt(e.target.value), page: 1 })}
                  className="border rounded px-2 py-1 text-sm"
                >
                  <option value="10">10æ¡</option>
                  <option value="20">20æ¡</option>
                  <option value="50">50æ¡</option>
                  <option value="100">100æ¡</option>
                </select>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-sm text-gray-600">
                ç¬¬ {pagination.page} / {Math.ceil(pagination.total / pagination.limit)} é¡µ
              </span>
              <button
                onClick={() => setPagination(prev => ({ ...prev, page: prev.page - 1 }))}
                disabled={pagination.page === 1}
                className="px-4 py-2 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ä¸Šä¸€é¡µ
              </button>
              <button
                onClick={() => setPagination(prev => ({ ...prev, page: prev.page + 1 }))}
                disabled={pagination.page >= Math.ceil(pagination.total / pagination.limit)}
                className="px-4 py-2 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ä¸‹ä¸€é¡µ
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  )
}
