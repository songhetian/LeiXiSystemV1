import React, { useState, useEffect } from 'react'
import { toast } from 'react-toastify'
import axios from 'axios'

const API_URL = 'http://localhost:3001/api'

const ExamManagement = () => {
  const [exams, setExams] = useState([])
  const [loading, setLoading] = useState(false)
  const [showModal, setShowModal] = useState(false)
  const [showEditorModal, setShowEditorModal] = useState(false)
  const [editingExam, setEditingExam] = useState(null)
  const [selectedExam, setSelectedExam] = useState(null)
  const [questions, setQuestions] = useState([])
  const [draggedQuestion, setDraggedQuestion] = useState(null)
  const [searchTerm, setSearchTerm] = useState('')
  const [questionBank, setQuestionBank] = useState([])
  const [bankSearchTerm, setBankSearchTerm] = useState('')
  const [editingQuestion, setEditingQuestion] = useState(null)
  const [showEditQuestionModal, setShowEditQuestionModal] = useState(false)

  const [formData, setFormData] = useState({
    title: '',
    description: '',
    category: '',
    difficulty: 'medium',
    duration: 60,
    total_score: 100,
    pass_score: 60,
    status: 'draft'
  })

  const [newQuestion, setNewQuestion] = useState({
    type: 'single_choice',
    content: '',
    options: ['', '', '', ''],
    correct_answer: '',
    score: 10,
    explanation: ''
  })

  useEffect(() => {
    fetchExams()
    fetchQuestionBank()
  }, [])

  const fetchQuestionBank = async () => {
    try {
      const response = await axios.get(`${API_URL}/question-bank`)
      setQuestionBank(response.data || [])
    } catch (error) {
      console.error('è·å–é¢˜åº“å¤±è´¥:', error)
      setQuestionBank([])
    }
  }

  const fetchExams = async () => {
    setLoading(true)
    try {
      const response = await axios.get(`${API_URL}/exams`)
      setExams(response.data || [])
    } catch (error) {
      console.error('è·å–è¯•å·å¤±è´¥:', error)
      toast.error('è·å–è¯•å·åˆ—è¡¨å¤±è´¥')
      setExams([])
    } finally {
      setLoading(false)
    }
  }

  const fetchQuestions = async (examId) => {
    try {
      const response = await axios.get(`${API_URL}/exams/${examId}/questions`)
      setQuestions(response.data || [])
    } catch (error) {
      console.error('è·å–é¢˜ç›®å¤±è´¥:', error)
      toast.error('è·å–é¢˜ç›®å¤±è´¥')
      setQuestions([])
    }
  }

  const handleSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    try {
      if (editingExam) {
        await axios.put(`${API_URL}/exams/${editingExam.id}`, formData)
        toast.success('è¯•å·æ›´æ–°æˆåŠŸ')
      } else {
        await axios.post(`${API_URL}/exams`, formData)
        toast.success('è¯•å·åˆ›å»ºæˆåŠŸ')
      }
      setShowModal(false)
      resetForm()
      fetchExams()
    } catch (error) {
      console.error('æäº¤å¤±è´¥:', error)
      toast.error(editingExam ? 'æ›´æ–°å¤±è´¥' : 'åˆ›å»ºå¤±è´¥')
    } finally {
      setLoading(false)
    }
  }

  const handleAddQuestion = async () => {
    if (!newQuestion.content.trim()) {
      toast.error('è¯·è¾“å…¥é¢˜ç›®å†…å®¹')
      return
    }

    if (newQuestion.type.includes('choice')) {
      const validOptions = newQuestion.options.filter(opt => opt.trim())
      if (validOptions.length < 2) {
        toast.error('è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹')
        return
      }
      if (!newQuestion.correct_answer) {
        toast.error('è¯·è®¾ç½®æ­£ç¡®ç­”æ¡ˆ')
        return
      }
    }

    try {
      const data = {
        ...newQuestion,
        exam_id: selectedExam.id,
        options: newQuestion.type.includes('choice') ? JSON.stringify(newQuestion.options.filter(opt => opt.trim())) : null,
        order_num: questions.length + 1
      }

      await axios.post(`${API_URL}/exams/${selectedExam.id}/questions`, data)
      toast.success('é¢˜ç›®æ·»åŠ æˆåŠŸ')
      resetQuestionForm()
      fetchQuestions(selectedExam.id)
    } catch (error) {
      console.error('æ·»åŠ é¢˜ç›®å¤±è´¥:', error)
      toast.error('æ·»åŠ é¢˜ç›®å¤±è´¥')
    }
  }

  const handleDeleteQuestion = async (questionId) => {
    if (!window.confirm('ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ')) return

    try {
      await axios.delete(`${API_URL}/questions/${questionId}`)
      toast.success('é¢˜ç›®åˆ é™¤æˆåŠŸ')
      fetchQuestions(selectedExam.id)
    } catch (error) {
      console.error('åˆ é™¤é¢˜ç›®å¤±è´¥:', error)
      toast.error('åˆ é™¤é¢˜ç›®å¤±è´¥')
    }
  }

  const handleEditQuestion = (question) => {
    setEditingQuestion(question)
    setNewQuestion({
      type: question.type,
      content: question.content,
      options: question.options ? JSON.parse(question.options) : ['', '', '', ''],
      correct_answer: question.correct_answer,
      score: question.score,
      explanation: question.explanation || ''
    })
    setShowEditQuestionModal(true)
  }

  const handleUpdateQuestion = async () => {
    if (!newQuestion.content.trim()) {
      toast.error('è¯·è¾“å…¥é¢˜ç›®å†…å®¹')
      return
    }

    if (newQuestion.type.includes('choice')) {
      const validOptions = newQuestion.options.filter(opt => opt.trim())
      if (validOptions.length < 2) {
        toast.error('è‡³å°‘éœ€è¦2ä¸ªé€‰é¡¹')
        return
      }
      if (!newQuestion.correct_answer) {
        toast.error('è¯·è®¾ç½®æ­£ç¡®ç­”æ¡ˆ')
        return
      }
    }

    try {
      const data = {
        type: newQuestion.type,
        content: newQuestion.content,
        options: newQuestion.type.includes('choice') ? JSON.stringify(newQuestion.options.filter(opt => opt.trim())) : null,
        correct_answer: newQuestion.correct_answer,
        score: newQuestion.score,
        explanation: newQuestion.explanation
      }

      await axios.put(`${API_URL}/questions/${editingQuestion.id}`, data)
      toast.success('é¢˜ç›®æ›´æ–°æˆåŠŸ')
      setShowEditQuestionModal(false)
      setEditingQuestion(null)
      resetQuestionForm()
      fetchQuestions(selectedExam.id)
    } catch (error) {
      console.error('æ›´æ–°é¢˜ç›®å¤±è´¥:', error)
      toast.error('æ›´æ–°é¢˜ç›®å¤±è´¥')
    }
  }

  const handleDeleteExam = async (examId) => {
    if (!window.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä»½è¯•å·å—ï¼Ÿ')) return

    try {
      await axios.delete(`${API_URL}/exams/${examId}`)
      toast.success('è¯•å·åˆ é™¤æˆåŠŸ')
      fetchExams()
    } catch (error) {
      console.error('åˆ é™¤è¯•å·å¤±è´¥:', error)
      toast.error('åˆ é™¤è¯•å·å¤±è´¥')
    }
  }

  const handleOpenEditor = async (exam) => {
    setSelectedExam(exam)
    await fetchQuestions(exam.id)
    setShowEditorModal(true)
  }

  // æ‹–æ‹½ç›¸å…³å‡½æ•°
  const handleDragStart = (e, question, index, source = 'exam') => {
    setDraggedQuestion({ question, index, source })
    e.dataTransfer.effectAllowed = source === 'bank' ? 'copy' : 'move'
  }

  const handleDragOver = (e) => {
    e.preventDefault()
    e.dataTransfer.dropEffect = 'move'
  }

  const handleDrop = async (e, targetIndex) => {
    e.preventDefault()

    if (!draggedQuestion) {
      return
    }

    // ä»é¢˜åº“æ‹–å…¥
    if (draggedQuestion.source === 'bank') {
      try {
        const bankQuestion = draggedQuestion.question
        const data = {
          type: bankQuestion.type,
          content: bankQuestion.content,
          options: bankQuestion.options,
          correct_answer: bankQuestion.correct_answer,
          score: bankQuestion.score || 10,
          explanation: bankQuestion.explanation || '',
          exam_id: selectedExam.id,
          order_num: targetIndex + 1
        }

        await axios.post(`${API_URL}/exams/${selectedExam.id}/questions`, data)
        toast.success('é¢˜ç›®å·²æ·»åŠ åˆ°è¯•å·')
        fetchQuestions(selectedExam.id)
      } catch (error) {
        console.error('æ·»åŠ é¢˜ç›®å¤±è´¥:', error)
        toast.error('æ·»åŠ é¢˜ç›®å¤±è´¥')
      }
      setDraggedQuestion(null)
      return
    }

    // è¯•å·å†…æ‹–æ‹½æ’åº
    if (draggedQuestion.index === targetIndex) {
      setDraggedQuestion(null)
      return
    }

    const newQuestions = [...questions]
    const [removed] = newQuestions.splice(draggedQuestion.index, 1)
    newQuestions.splice(targetIndex, 0, removed)

    setQuestions(newQuestions)
    setDraggedQuestion(null)

    try {
      const updates = newQuestions.map((q, idx) => ({
        id: q.id,
        order_num: idx + 1
      }))

      await axios.put(`${API_URL}/exams/${selectedExam.id}/questions/reorder`, { questions: updates })
      toast.success('é¢˜ç›®é¡ºåºå·²æ›´æ–°')
    } catch (error) {
      console.error('æ›´æ–°é¡ºåºå¤±è´¥:', error)
      toast.error('æ›´æ–°é¡ºåºå¤±è´¥')
      fetchQuestions(selectedExam.id)
    }
  }

  const resetForm = () => {
    setFormData({
      title: '',
      description: '',
      category: '',
      difficulty: 'medium',
      duration: 60,
      total_score: 100,
      pass_score: 60,
      status: 'draft'
    })
    setEditingExam(null)
  }

  const resetQuestionForm = () => {
    setNewQuestion({
      type: 'single_choice',
      content: '',
      options: ['', '', '', ''],
      correct_answer: '',
      score: 10,
      explanation: ''
    })
  }

  const getQuestionTypeLabel = (type) => {
    const types = {
      single_choice: 'å•é€‰é¢˜',
      multiple_choice: 'å¤šé€‰é¢˜',
      true_false: 'åˆ¤æ–­é¢˜',
      fill_blank: 'å¡«ç©ºé¢˜',
      short_answer: 'ç®€ç­”é¢˜'
    }
    return types[type] || type
  }

  const getDifficultyBadge = (difficulty) => {
    const badges = {
      easy: 'bg-green-100 text-green-700',
      medium: 'bg-yellow-100 text-yellow-700',
      hard: 'bg-red-100 text-red-700'
    }
    const labels = {
      easy: 'ç®€å•',
      medium: 'ä¸­ç­‰',
      hard: 'å›°éš¾'
    }
    return (
      <span className={`px-2 py-1 rounded-full text-xs ${badges[difficulty]}`}>
        {labels[difficulty]}
      </span>
    )
  }

  const getStatusBadge = (status) => {
    const badges = {
      draft: 'bg-gray-100 text-gray-700',
      published: 'bg-green-100 text-green-700',
      archived: 'bg-yellow-100 text-yellow-700'
    }
    const labels = {
      draft: 'è‰ç¨¿',
      published: 'å·²å‘å¸ƒ',
      archived: 'å·²å½’æ¡£'
    }
    return (
      <span className={`px-2 py-1 rounded-full text-xs ${badges[status]}`}>
        {labels[status]}
      </span>
    )
  }

  const filteredExams = exams.filter(exam =>
    exam.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
    exam.category?.toLowerCase().includes(searchTerm.toLowerCase())
  )

  return (
    <div className="p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-800">ğŸ“ è¯•å·ç®¡ç†</h1>
        <p className="text-gray-600 mt-1">åˆ›å»ºå’Œç®¡ç†è€ƒæ ¸è¯•å·</p>
      </div>

      {/* æ“ä½œæ  */}
      <div className="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div className="flex items-center gap-3">
          <button
            onClick={() => {
              resetForm()
              setShowModal(true)
            }}
            className="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors"
          >
            â• æ–°å»ºè¯•å·
          </button>
          <input
            type="text"
            placeholder="æœç´¢è¯•å·..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          />
        </div>
      </div>

      {/* è¯•å·åˆ—è¡¨ */}
      {loading ? (
        <div className="bg-white rounded-lg shadow-sm p-12 text-center">
          <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
          <p className="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
        </div>
      ) : filteredExams.length === 0 ? (
        <div className="bg-white rounded-lg shadow-sm p-12 text-center">
          <p className="text-gray-500">æš‚æ— è¯•å·</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredExams.map(exam => (
            <div key={exam.id} className="bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition-all border border-gray-200">
              <div className="flex items-start justify-between mb-3">
                <h3 className="font-semibold text-gray-900 text-lg flex-1 pr-2">
                  {exam.title}
                </h3>
                {getStatusBadge(exam.status)}
              </div>

              {exam.description && (
                <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                  {exam.description}
                </p>
              )}

              <div className="space-y-2 text-sm text-gray-600 mb-4">
                {exam.category && (
                  <div className="flex items-center gap-2">
                    <span>ğŸ“š</span>
                    <span>{exam.category}</span>
                  </div>
                )}
                <div className="flex items-center gap-2">
                  {getDifficultyBadge(exam.difficulty)}
                  <span>â±ï¸ {exam.duration}åˆ†é’Ÿ</span>
                  <span>ğŸ’¯ {exam.total_score}åˆ†</span>
                </div>
                <div className="flex items-center gap-2">
                  <span>âœ… åŠæ ¼åˆ†: {exam.pass_score}åˆ†</span>
                </div>
              </div>

              <div className="flex items-center gap-2 pt-3 border-t border-gray-100">
                <button
                  onClick={() => handleOpenEditor(exam)}
                  className="flex-1 px-3 py-2 bg-primary-500 text-white rounded hover:bg-primary-600 transition-colors text-sm"
                >
                  ğŸ“ ç¼–è¾‘é¢˜ç›®
                </button>
                <button
                  onClick={() => {
                    setEditingExam(exam)
                    setFormData({
                      title: exam.title,
                      description: exam.description || '',
                      category: exam.category || '',
                      difficulty: exam.difficulty,
                      duration: exam.duration,
                      total_score: exam.total_score,
                      pass_score: exam.pass_score,
                      status: exam.status
                    })
                    setShowModal(true)
                  }}
                  className="px-3 py-2 text-blue-600 hover:bg-blue-50 rounded transition-colors text-sm"
                >
                  âœï¸
                </button>
                <button
                  onClick={() => handleDeleteExam(exam.id)}
                  className="px-3 py-2 text-red-600 hover:bg-red-50 rounded transition-colors text-sm"
                >
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* åˆ›å»º/ç¼–è¾‘è¯•å·Modal */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg w-full max-w-2xl">
            <div className="p-6 border-b border-gray-200 flex items-center justify-between">
              <h2 className="text-xl font-bold text-gray-800">
                {editingExam ? 'ç¼–è¾‘è¯•å·' : 'æ–°å»ºè¯•å·'}
              </h2>
              <button
                onClick={() => {
                  setShowModal(false)
                  resetForm()
                }}
                className="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors"
              >
                âœ•
              </button>
            </div>

            <form onSubmit={handleSubmit} className="p-6 space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">è¯•å·æ ‡é¢˜ *</label>
                <input
                  type="text"
                  required
                  value={formData.title}
                  onChange={(e) => setFormData({ ...formData, title: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                  placeholder="è¾“å…¥è¯•å·æ ‡é¢˜"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">è¯•å·æè¿°</label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData({ ...formData, description: e.target.value })}
                  rows="3"
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                  placeholder="è¾“å…¥è¯•å·æè¿°"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">åˆ†ç±»</label>
                  <input
                    type="text"
                    value={formData.category}
                    onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                    placeholder="å¦‚ï¼šäº§å“çŸ¥è¯†ã€æŠ€èƒ½è€ƒæ ¸"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">éš¾åº¦ *</label>
                  <select
                    required
                    value={formData.difficulty}
                    onChange={(e) => setFormData({ ...formData, difficulty: e.target.value })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                  >
                    <option value="easy">ç®€å•</option>
                    <option value="medium">ä¸­ç­‰</option>
                    <option value="hard">å›°éš¾</option>
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">è€ƒè¯•æ—¶é•¿(åˆ†é’Ÿ) *</label>
                  <input
                    type="number"
                    required
                    min="1"
                    value={formData.duration}
                    onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">æ€»åˆ† *</label>
                  <input
                    type="number"
                    required
                    min="1"
                    value={formData.total_score}
                    onChange={(e) => setFormData({ ...formData, total_score: parseInt(e.target.value) })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">åŠæ ¼åˆ† *</label>
                  <input
                    type="number"
                    required
                    min="1"
                    value={formData.pass_score}
                    onChange={(e) => setFormData({ ...formData, pass_score: parseInt(e.target.value) })}
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">çŠ¶æ€ *</label>
                <select
                  required
                  value={formData.status}
                  onChange={(e) => setFormData({ ...formData, status: e.target.value })}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                >
                  <option value="draft">è‰ç¨¿</option>
                  <option value="published">å·²å‘å¸ƒ</option>
                  <option value="archived">å·²å½’æ¡£</option>
                </select>
              </div>

              <div className="flex justify-end gap-3 pt-4">
                <button
                  type="button"
                  onClick={() => {
                    setShowModal(false)
                    resetForm()
                  }}
                  className="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                >
                  å–æ¶ˆ
                </button>
                <button
                  type="submit"
                  disabled={loading}
                  className="px-6 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50"
                >
                  {loading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* æ‹–æ‹½ç¼–è¾‘å™¨Modal */}
      {showEditorModal && selectedExam && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg w-full max-w-7xl max-h-[90vh] flex flex-col">
            {/* å¤´éƒ¨ */}
            <div className="p-6 border-b border-gray-200 flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold text-gray-800">{selectedExam.title}</h2>
                <p className="text-sm text-gray-600 mt-1">
                  æ‹–æ‹½é¢˜ç›®å¯è°ƒæ•´é¡ºåº Â· å…± {questions.length} é“é¢˜
                </p>
              </div>
              <button
                onClick={() => {
                  setShowEditorModal(false)
                  setSelectedExam(null)
                  setQuestions([])
                }}
                className="w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 transition-colors"
              >
                âœ•
              </button>
            </div>

            <div className="flex-1 overflow-hidden flex">
              {/* å·¦ä¾§ï¼šé¢˜ç›®åˆ—è¡¨ */}
              <div className="w-2/3 border-r border-gray-200 flex flex-col">
                <div className="p-4 border-b border-gray-200 bg-gray-50">
                  <h3 className="font-semibold text-gray-800">ğŸ“‹ é¢˜ç›®åˆ—è¡¨</h3>
                </div>

                <div className="flex-1 overflow-y-auto p-4">
                  {questions.length === 0 ? (
                    <div className="text-center py-12 text-gray-500">
                      æš‚æ— é¢˜ç›®ï¼Œè¯·åœ¨å³ä¾§æ·»åŠ é¢˜ç›®
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {questions.map((question, index) => (
                        <div
                          key={question.id}
                          draggable
                          onDragStart={(e) => handleDragStart(e, question, index)}
                          onDragOver={handleDragOver}
                          onDrop={(e) => handleDrop(e, index)}
                          className={`bg-white border-2 rounded-lg p-4 cursor-move hover:shadow-md transition-all ${
                            draggedQuestion?.index === index
                              ? 'border-primary-500 opacity-50'
                              : 'border-gray-200 hover:border-primary-300'
                          }`}
                        >
                          <div className="flex items-start gap-3">
                            <div className="flex-shrink-0">
                              <div className="w-8 h-8 bg-primary-100 text-primary-700 rounded-full flex items-center justify-center font-semibold text-sm">
                                {index + 1}
                              </div>
                            </div>

                            <div className="flex-1 min-w-0">
                              <div className="flex items-center gap-2 mb-2">
                                <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                                  {getQuestionTypeLabel(question.type)}
                                </span>
                                <span className="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">
                                  {question.score}åˆ†
                                </span>
                              </div>

                              <p className="text-gray-900 font-medium mb-2">
                                {question.content}
                              </p>

                              {question.type.includes('choice') && question.options && (
                                <div className="space-y-1 text-sm">
                                  {JSON.parse(question.options).map((option, idx) => (
                                    <div
                                      key={idx}
                                      className={`flex items-center gap-2 ${
                                        question.correct_answer === String.fromCharCode(65 + idx)
                                          ? 'text-green-600 font-medium'
                                          : 'text-gray-600'
                                      }`}
                                    >
                                      <span className="font-semibold">
                                        {String.fromCharCode(65 + idx)}.
                                      </span>
                                      <span>{option}</span>
                                      {question.correct_answer === String.fromCharCode(65 + idx) && (
                                        <span className="text-green-600">âœ“</span>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              )}

                              {question.explanation && (
                                <div className="mt-2 p-2 bg-yellow-50 border-l-2 border-yellow-400 text-sm text-gray-700">
                                  <span className="font-medium">è§£æï¼š</span>
                                  {question.explanation}
                                </div>
                              )}
                            </div>

                            <div className="flex-shrink-0 flex flex-col gap-2">
                              <button
                                onClick={() => handleDeleteQuestion(question.id)}
                                className="p-2 text-red-600 hover:bg-red-50 rounded transition-colors"
                                title="åˆ é™¤"
                              >
                                ğŸ—‘ï¸
                              </button>
                              <div className="p-2 text-gray-400 cursor-grab active:cursor-grabbing" title="æ‹–æ‹½æ’åº">
                                â‹®â‹®
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* å³ä¾§ï¼šæ·»åŠ é¢˜ç›® */}
              <div className="w-1/3 flex flex-col">
                <div className="p-4 border-b border-gray-200 bg-gray-50">
                  <h3 className="font-semibold text-gray-800">â• æ·»åŠ é¢˜ç›®</h3>
                </div>

                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                  {/* é¢˜ç›®ç±»å‹ */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">é¢˜ç›®ç±»å‹</label>
                    <select
                      value={newQuestion.type}
                      onChange={(e) => setNewQuestion({ ...newQuestion, type: e.target.value })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                    >
                      <option value="single_choice">å•é€‰é¢˜</option>
                      <option value="multiple_choice">å¤šé€‰é¢˜</option>
                      <option value="true_false">åˆ¤æ–­é¢˜</option>
                      <option value="fill_blank">å¡«ç©ºé¢˜</option>
                      <option value="short_answer">ç®€ç­”é¢˜</option>
                    </select>
                  </div>

                  {/* é¢˜ç›®å†…å®¹ */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">é¢˜ç›®å†…å®¹ *</label>
                    <textarea
                      value={newQuestion.content}
                      onChange={(e) => setNewQuestion({ ...newQuestion, content: e.target.value })}
                      rows="3"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                      placeholder="è¾“å…¥é¢˜ç›®å†…å®¹"
                    />
                  </div>

                  {/* é€‰é¡¹ï¼ˆä»…é€‰æ‹©é¢˜å’Œåˆ¤æ–­é¢˜ï¼‰ */}
                  {newQuestion.type.includes('choice') && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">é€‰é¡¹</label>
                      <div className="space-y-2">
                        {newQuestion.options.map((option, index) => (
                          <div key={index} className="flex items-center gap-2">
                            <span className="text-sm font-medium text-gray-600 w-6">
                              {String.fromCharCode(65 + index)}.
                            </span>
                            <input
                              type="text"
                              value={option}
                              onChange={(e) => {
                                const newOptions = [...newQuestion.options]
                                newOptions[index] = e.target.value
                                setNewQuestion({ ...newQuestion, options: newOptions })
                              }}
                              className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                              placeholder={`é€‰é¡¹ ${String.fromCharCode(65 + index)}`}
                            />
                          </div>
                        ))}
                      </div>
                      <button
                        type="button"
                        onClick={() => {
                          if (newQuestion.options.length < 6) {
                            setNewQuestion({
                              ...newQuestion,
                              options: [...newQuestion.options, '']
                            })
                          }
                        }}
                        className="mt-2 text-sm text-primary-600 hover:text-primary-700"
                      >
                        + æ·»åŠ é€‰é¡¹
                      </button>
                    </div>
                  )}

                  {newQuestion.type === 'true_false' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">é€‰é¡¹</label>
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-gray-600 w-6">A.</span>
                          <input
                            type="text"
                            value="æ­£ç¡®"
                            disabled
                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                          />
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-sm font-medium text-gray-600 w-6">B.</span>
                          <input
                            type="text"
                            value="é”™è¯¯"
                            disabled
                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"
                          />
                        </div>
                      </div>
                    </div>
                  )}

                  {/* æ­£ç¡®ç­”æ¡ˆ */}
                  {(newQuestion.type.includes('choice') || newQuestion.type === 'true_false') && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">æ­£ç¡®ç­”æ¡ˆ *</label>
                      {newQuestion.type === 'multiple_choice' ? (
                        <input
                          type="text"
                          value={newQuestion.correct_answer}
                          onChange={(e) => setNewQuestion({ ...newQuestion, correct_answer: e.target.value.toUpperCase() })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                          placeholder="å¦‚ï¼šABCï¼ˆå¤šä¸ªç­”æ¡ˆï¼‰"
                        />
                      ) : (
                        <select
                          value={newQuestion.correct_answer}
                          onChange={(e) => setNewQuestion({ ...newQuestion, correct_answer: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                        >
                          <option value="">è¯·é€‰æ‹©</option>
                          {newQuestion.type === 'true_false' ? (
                            <>
                              <option value="A">A. æ­£ç¡®</option>
                              <option value="B">B. é”™è¯¯</option>
                            </>
                          ) : (
                            newQuestion.options.map((option, index) => (
                              option.trim() && (
                                <option key={index} value={String.fromCharCode(65 + index)}>
                                  {String.fromCharCode(65 + index)}. {option}
                                </option>
                              )
                            ))
                          )}
                        </select>
                      )}
                    </div>
                  )}

                  {/* åˆ†å€¼ */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">åˆ†å€¼ *</label>
                    <input
                      type="number"
                      min="1"
                      value={newQuestion.score}
                      onChange={(e) => setNewQuestion({ ...newQuestion, score: parseInt(e.target.value) || 0 })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                    />
                  </div>

                  {/* è§£æ */}
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">ç­”æ¡ˆè§£æ</label>
                    <textarea
                      value={newQuestion.explanation}
                      onChange={(e) => setNewQuestion({ ...newQuestion, explanation: e.target.value })}
                      rows="3"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 text-sm"
                      placeholder="è¾“å…¥ç­”æ¡ˆè§£æï¼ˆå¯é€‰ï¼‰"
                    />
                  </div>

                  <button
                    onClick={handleAddQuestion}
                    className="w-full px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 transition-colors"
                  >
                    â• æ·»åŠ é¢˜ç›®
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default ExamManagement
