# 通知功能快速修复指南

## 🚨 紧急问题

从日志来看，排班更新执行了，但**没有看到通知创建的日志**。

## ✅ 立即执行以下步骤

### 步骤1：停止服务器（必须！）

在运行服务器的终端窗口中：

**按 `Ctrl+C` 停止服务器**

### 步骤2：确认代码已保存

打开 `server/routes/leave.js` 文件，确认第359行附近有：

```javascript
// 发送通知给申请人（在排班更新之前）
try {
  console.log('=== 开始创建请假审批通知 ===')
```

如果没有，说明代码没有保存或被覆盖了。

### 步骤3：重新启动服务器

```bash
npm run dev
```

**等待服务器完全启动**，看到类似这样的输出：
```
Server listening at http://0.0.0.0:3001
```

### 步骤4：测试审批

1. **创建新的请假申请**（不要用旧的）
2. **审批通过**
3. **立即查看服务器日志**

### 步骤5：检查日志输出

**正确的日志顺序应该是**：

```
=== 转换假期扣减开始 ===
=== 转换假期扣减结束 ===
=== 开始创建请假审批通知 ===    ← 这个必须出现！
申请人user_id: 11
请假记录ID: 52
✅ 通知创建成功，通知ID: 21      ← 这个必须出现！
=== 请假审批通知创建完成 ===
📍 准备调用排班更新函数...
🔄 开始自动更新排班...
✅ 已自动更新员工 11 的排班为休息
💾 准备提交事务...
✅ 事务提交成功！
```

**如果还是看不到通知创建的日志**，说明：
- 服务器没有重启
- 或者代码有问题

## 🔍 如果还是不行

### 方案A：手动验证代码

运行这个命令检查代码：

```bash
grep -n "开始创建请假审批通知" server/routes/leave.js
```

应该输出：
```
360:          console.log('=== 开始创建请假审批通知 ===')
```

如果没有输出，说明代码没有保存。

### 方案B：查看完整的服务器日志

从审批开始到结束的完整日志，看看是否有错误信息。

### 方案C：检查数据库

```bash
node check_notifications.js
```

查看是否有新的通知记录。

## 📝 重要提示

### 1. 必须重启服务器

**Node.js不会自动重新加载代码**，修改代码后必须重启服务器！

### 2. 使用nodemon自动重启

如果经常修改代码，建议使用nodemon：

```bash
npm install -g nodemon
nodemon server/index.js
```

这样修改代码后会自动重启。

### 3. 检查package.json

确认启动命令：

```json
{
  "scripts": {
    "dev": "node server/index.js",
    "dev:watch": "nodemon server/index.js"
  }
}
```

使用 `npm run dev:watch` 可以自动重启。

## 🎯 预期结果

重启服务器并审批请假后，应该：

1. ✅ 服务器日志中看到"开始创建请假审批通知"
2. ✅ 服务器日志中看到"通知创建成功，通知ID: xxx"
3. ✅ 数据库中有新的通知记录
4. ✅ 前端"我的通知"页面能看到通知

## 🆘 如果以上都不行

请提供：

1. **完整的服务器启动日志**
2. **完整的审批过程日志**
3. **`server/routes/leave.js` 文件的第350-400行代码**

这样我可以进一步诊断问题。

## ⚡ 快速检查命令

```bash
# 1. 检查代码是否包含通知创建
grep "开始创建请假审批通知" server/routes/leave.js

# 2. 检查数据库通知
node check_notifications.js

# 3. 检查服务器进程
ps aux | grep node

# 4. 强制结束所有node进程（谨慎使用）
# pkill -9 node
```

## 🔧 终极解决方案

如果以上都不行，手动添加调试日志：

在 `server/routes/leave.js` 第355行（通知创建之前）添加：

```javascript
console.log('🔔🔔🔔 DEBUG: 即将创建通知');
console.log('🔔🔔🔔 DEBUG: leaveRecord.user_id =', leaveRecord.user_id);
console.log('🔔🔔🔔 DEBUG: 请假记录ID =', id);
```

保存，重启服务器，再次测试。

如果看到这些DEBUG日志但没有看到"开始创建请假审批通知"，说明代码有语法错误或被注释掉了。
