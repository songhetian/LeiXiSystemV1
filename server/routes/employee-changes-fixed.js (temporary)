// åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•
fastify.post('/api/employee-changes/create', async (request, reply) => {
  const {
    employee_id,
    user_id,
    change_type,
    change_date,
    old_department_id,
    new_department_id,
    old_position,
    new_position,
    reason
  } = request.body;

  try {
    if (!employee_id || !user_id || !change_type || !change_date) {
      return reply.code(400).send({ error: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' });
    }

    // 1. è‡ªåŠ¨è·å–å½“å‰çš„ position_id ä½œä¸ºæ—§èŒä½ ID
    const [currentEmp] = await pool.query(
      'SELECT position_id, department_id FROM employees WHERE id = ?',
      [employee_id]
    );
    
    const oldPosId = currentEmp[0]?.position_id || null;
    const oldDeptId = old_department_id || currentEmp[0]?.department_id || null;

    // 2. å¦‚æœä¼ äº†æ–°èŒä½åç§°ï¼Œå°è¯•è·å–å…¶ ID
    let newPosId = null;
    if (new_position) {
      const [posRows] = await pool.query('SELECT id FROM positions WHERE name = ?', [new_position]);
      if (posRows.length > 0) newPosId = posRows[0].id;
    }

    const formattedChangeDate = change_date.split('T')[0];

    // 3. å†™å…¥æ•°æ®åº“ï¼ŒåŒ…å«æ‚¨è¦æ±‚çš„ ID å­—æ®µ
    const [result] = await pool.query(
      `INSERT INTO employee_changes
      (employee_id, user_id, change_type, change_date, 
       old_department_id, new_department_id, 
       old_position, new_position, 
       old_position_id, new_position_id, reason)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        employee_id,
        user_id,
        change_type,
        formattedChangeDate,
        oldDeptId,
        new_department_id || oldDeptId,
        old_position || null,
        new_position || null,
        oldPosId,
        newPosId,
        reason || null
      ]
    );

    // ğŸ”´ å…³é”®ä¿®å¤ï¼šæ¸…é™¤å‘˜å·¥åˆ—è¡¨ Redis ç¼“å­˜
    const redis = fastify.redis;
    if (redis) {
      const keys = await redis.keys('list:employees:default:*');
      if (keys.length > 0) await redis.del(...keys);
    }

    return { success: true, id: result.insertId };
  } catch (error) {
    console.error('âŒ åˆ›å»ºå˜åŠ¨è®°å½•å¤±è´¥:', error);
    return reply.code(500).send({ error: 'åˆ›å»ºå˜åŠ¨è®°å½•å¤±è´¥', message: error.message });
  }
});
