const fastify = require('fastify')({
  logger: true,
  bodyLimit: 10485760 // 10MB
})
const cors = require('@fastify/cors')
const multipart = require('@fastify/multipart')
const mysql = require('mysql2/promise')
const bcrypt = require('bcryptjs')
const jwt = require('jsonwebtoken')
const fs = require('fs')
const path = require('path')
const { pipeline } = require('stream')
const util = require('util')
const pump = util.promisify(pipeline)
require('dotenv').config()

// å¼•å…¥æƒé™ä¸­é—´ä»¶
const { extractUserPermissions, applyDepartmentFilter } = require('./middleware/checkPermission')

// æ³¨å†Œ CORS
fastify.register(cors, {
  origin: '*'
})

// æ³¨å†Œæ–‡ä»¶ä¸Šä¼ 
// æ³¨æ„ï¼šmultipart åªå¤„ç† multipart/form-dataï¼Œä¸å½±å“ application/json
fastify.register(multipart, {
  limits: {
    fileSize: 100 * 1024 * 1024 // 100MB
  }
})

// æ·»åŠ è¯·æ±‚æ—¥å¿—é’©å­
fastify.addHook('onRequest', async (request, reply) => {
  if (request.url.includes('/api/knowledge/articles') && (request.method === 'PUT' || request.method === 'POST')) {
  }
})

fastify.addHook('preHandler', async (request, reply) => {
  if (request.url.includes('/api/knowledge/articles') && (request.method === 'PUT' || request.method === 'POST')) {
  }
})

// åˆ›å»ºä¸Šä¼ ç›®å½•
const uploadDir = path.join(__dirname, '../uploads')
if (!fs.existsSync(uploadDir)) {
  fs.mkdirSync(uploadDir, { recursive: true })
}

// é™æ€æ–‡ä»¶æœåŠ¡
fastify.register(require('@fastify/static'), {
  root: uploadDir,
  prefix: '/uploads/'
})

// JWT å¯†é’¥
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key'

// æ•°æ®åº“é…ç½®
const dbConfig = {
  host: process.env.DB_HOST || 'localhost',
  user: process.env.DB_USER || 'root',
  password: process.env.DB_PASSWORD || 'root',
  database: process.env.DB_NAME || 'leixin_customer_service',
  port: process.env.DB_PORT || 3306,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0,
  timezone: '+08:00'  // è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
}

let pool

// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± 
async function initDatabase() {
  try {
    pool = mysql.createPool(dbConfig)

    // è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´
    const connection = await pool.getConnection()
    await connection.query("SET time_zone = '+08:00'")
    connection.release()

    // å°† pool è£…é¥°åˆ° fastify å®ä¾‹ä¸Šï¼Œä¾›è·¯ç”±ä½¿ç”¨
    fastify.decorate('mysql', pool)
    console.error('âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ')
  } catch (error) {
    console.error('âŒ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥:', error)
  }
}

// å¥åº·æ£€æŸ¥
fastify.get('/api/health', async (request, reply) => {
  return { status: 'ok', message: 'æœåŠ¡æ­£å¸¸' }
})

// ==================== æ–‡ä»¶ä¸Šä¼  API ====================

// å•ä¸ªæ–‡ä»¶ä¸Šä¼ 
fastify.post('/api/upload', async (request, reply) => {
  try {
    const data = await request.file()

    if (!data) {
      return reply.code(400).send({ error: 'æ²¡æœ‰ä¸Šä¼ æ–‡ä»¶' })
    }

    // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    const timestamp = Date.now()
    const randomStr = Math.random().toString(36).substring(7)
    const ext = path.extname(data.filename)
    const filename = `${timestamp}-${randomStr}${ext}`
    const filepath = path.join(uploadDir, filename)

    // ä¿å­˜æ–‡ä»¶
    await pump(data.file, fs.createWriteStream(filepath))

    // è¿”å›æ–‡ä»¶URL
    const fileUrl = `http://localhost:3001/uploads/${filename}`

    return {
      success: true,
      url: fileUrl,
      filename: data.filename,
      size: fs.statSync(filepath).size
    }
  } catch (error) {
    console.error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥:', error)
    return reply.code(500).send({ error: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥' })
  }
})

// æ‰¹é‡æ–‡ä»¶ä¸Šä¼ 
fastify.post('/api/upload/multiple', async (request, reply) => {
  try {
    const parts = request.parts()
    const uploadedFiles = []

    for await (const part of parts) {
      if (part.file) {
        // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        const timestamp = Date.now()
        const randomStr = Math.random().toString(36).substring(7)
        const ext = path.extname(part.filename)
        const filename = `${timestamp}-${randomStr}${ext}`
        const filepath = path.join(uploadDir, filename)

        // ä¿å­˜æ–‡ä»¶
        await pump(part.file, fs.createWriteStream(filepath))

        // æ”¶é›†ç»“æœ
        uploadedFiles.push({
          url: `http://localhost:3001/uploads/${filename}`,
          filename: part.filename,
          size: fs.statSync(filepath).size
        })
      }
    }

    return {
      success: true,
      files: uploadedFiles
    }
  } catch (error) {
    console.error('æ‰¹é‡ä¸Šä¼ å¤±è´¥:', error)
    return reply.code(500).send({ error: 'æ‰¹é‡ä¸Šä¼ å¤±è´¥' })
  }
})

// ==================== è®¤è¯ API ====================

// ç”¨æˆ·æ³¨å†Œ
fastify.post('/api/auth/register', async (request, reply) => {
  const { username, password, real_name, email, phone } = request.body

  try {
    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    const [existing] = await pool.query('SELECT id FROM users WHERE username = ?', [username])
    if (existing.length > 0) {
      return reply.code(400).send({ success: false, message: 'ç”¨æˆ·åå·²å­˜åœ¨' })
    }

    // åŠ å¯†å¯†ç 
    const passwordHash = await bcrypt.hash(password, 10)

    // æ³¨å†Œç”¨æˆ·
    const [result] = await pool.query(
      'INSERT INTO users (username, password_hash, real_name, email, phone, status) VALUES (?, ?, ?, ?, ?, ?)',
      [username, passwordHash, real_name, email, phone, 'active']
    )

    return { success: true, message: 'æ³¨å†ŒæˆåŠŸ', userId: result.insertId }
  } catch (error) {
    console.error('æ³¨å†Œå¤±è´¥:', error)
    return reply.code(500).send({ success: false, message: 'æ³¨å†Œå¤±è´¥' })
  }
})

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰æ´»è·ƒä¼šè¯
fastify.post('/api/auth/check-session', async (request, reply) => {
  const { username } = request.body

  try {
    // æŸ¥è¯¢ç”¨æˆ·çš„session_token
    const [users] = await pool.query(
      'SELECT id, session_token, session_created_at FROM users WHERE username = ?',
      [username]
    )

    if (users.length === 0) {
      return { hasActiveSession: false }
    }

    const user = users[0]

    // å¦‚æœæœ‰session_tokenï¼Œè¯´æ˜æœ‰æ´»è·ƒä¼šè¯
    if (user.session_token) {
      // éªŒè¯tokenæ˜¯å¦è¿˜æœ‰æ•ˆ
      try {
        jwt.verify(user.session_token, JWT_SECRET)

        // Tokenæœ‰æ•ˆï¼Œè¿”å›ä¼šè¯ä¿¡æ¯
        return {
          hasActiveSession: true,
          sessionCreatedAt: user.session_created_at,
          message: 'è¯¥è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•'
        }
      } catch (error) {
        // Tokenå·²è¿‡æœŸï¼Œè§†ä¸ºæ— æ´»è·ƒä¼šè¯
        return { hasActiveSession: false }
      }
    }

    return { hasActiveSession: false }
  } catch (error) {
    console.error('æ£€æŸ¥ä¼šè¯å¤±è´¥:', error)
    return reply.code(500).send({ success: false, message: 'æ£€æŸ¥ä¼šè¯å¤±è´¥' })
  }
})

// ç”¨æˆ·ç™»å½•
fastify.post('/api/auth/login', async (request, reply) => {
  const { username, password, forceLogin } = request.body

  try {
    // æŸ¥è¯¢ç”¨æˆ·
    const [users] = await pool.query(
      'SELECT id, username, password_hash, real_name, email, phone, status FROM users WHERE username = ?',
      [username]
    )

    if (users.length === 0) {
      return reply.code(401).send({ success: false, message: 'Invalid username or password' })
    }

    const user = users[0]

    // è´¦å·çŠ¶æ€æ£€æŸ¥
    if (user.status === 'pending') {
      return reply.code(403).send({ success: false, message: 'è´¦å·å¾…å®¡æ ¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜' })
    }

    if (user.status !== 'active') {
      return reply.code(403).send({ success: false, message: 'è´¦å·å·²ç¦ç”¨' })
    }

    // éªŒè¯å¯†ç 
    const isValid = await bcrypt.compare(password, user.password_hash)
    if (!isValid) {
      return reply.code(401).send({ success: false, message: 'Invalid username or password' })
    }

    // ç”Ÿæˆ JWT tokenï¼ˆåŒ…å«æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§ï¼‰
    const sessionId = `${user.id}_${Date.now()}_${Math.random().toString(36).substring(7)}`
    const token = jwt.sign(
      { id: user.id, username: user.username, sessionId },
      JWT_SECRET,
      { expiresIn: '7d' }
    )

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´å’Œsession_tokenï¼ˆå®ç°å•è®¾å¤‡ç™»å½•ï¼‰
    await pool.query(
      'UPDATE users SET last_login = NOW(), session_token = ?, session_created_at = NOW() WHERE id = ?',
      [token, user.id]
    )

    // è¿”å›ç™»å½•ä¿¡æ¯ï¼ˆä¸åŒ…å«å¯†ç ï¼‰
    const { password_hash, ...userInfo } = user

    return {
      success: true,
      message: 'ç™»å½•æˆåŠŸ',
      token,
      user: userInfo
    }
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error)
    return reply.code(500).send({ success: false, message: 'ç™»å½•å¤±è´¥' })
  }
})

// ç”¨æˆ·é€€å‡ºç™»å½•
fastify.post('/api/auth/logout', async (request, reply) => {
  try {
    const token = request.headers.authorization?.replace('Bearer ', '')
    if (!token) {
      return reply.code(401).send({ success: false, message: 'æœªç™»å½•' })
    }

    const decoded = jwt.verify(token, JWT_SECRET)

    // æ¸…é™¤æ•°æ®åº“ä¸­çš„session_token
    await pool.query(
      'UPDATE users SET session_token = NULL, session_created_at = NULL WHERE id = ?',
      [decoded.id]
    )

    return {
      success: true,
      message: 'é€€å‡ºç™»å½•æˆåŠŸ'
    }
  } catch (error) {
    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error)
    // å³ä½¿å‡ºé”™ä¹Ÿè¿”å›æˆåŠŸï¼Œå› ä¸ºå‰ç«¯ä¼šæ¸…é™¤æœ¬åœ°token
    return {
      success: true,
      message: 'é€€å‡ºç™»å½•æˆåŠŸ'
    }
  }
})

// é‡ç½®ç”¨æˆ·å¯†ç ï¼ˆç®¡ç†å‘˜åŠŸèƒ½ï¼‰
fastify.post('/api/users/:userId/reset-password', async (request, reply) => {
  const { userId } = request.params
  const { newPassword } = request.body

  try {
    const token = request.headers.authorization?.replace('Bearer ', '')
    if (!token) {
      return reply.code(401).send({ success: false, message: 'æœªç™»å½•' })
    }

    // éªŒè¯token
    const decoded = jwt.verify(token, JWT_SECRET)

    // éªŒè¯æ–°å¯†ç 
    if (!newPassword || newPassword.length < 6) {
      return reply.code(400).send({ success: false, message: 'å¯†ç é•¿åº¦è‡³å°‘6ä½' })
    }

    // åŠ å¯†æ–°å¯†ç 
    const passwordHash = await bcrypt.hash(newPassword, 10)

    // æ›´æ–°å¯†ç å¹¶æ¸…é™¤session_tokenï¼ˆå¼ºåˆ¶é‡æ–°ç™»å½•ï¼‰
    await pool.query(
      'UPDATE users SET password_hash = ?, session_token = NULL, session_created_at = NULL WHERE id = ?',
      [passwordHash, userId]
    )

    // è®°å½•æ“ä½œæ—¥å¿—ï¼ˆå¯é€‰ï¼‰

    return {
      success: true,
      message: 'å¯†ç é‡ç½®æˆåŠŸ'
    }
  } catch (error) {
    console.error('é‡ç½®å¯†ç å¤±è´¥:', error)
    if (error.name === 'JsonWebTokenError') {
      return reply.code(401).send({ success: false, message: 'Tokenæ— æ•ˆ' })
    }
    return reply.code(500).send({ success: false, message: 'é‡ç½®å¯†ç å¤±è´¥' })
  }
})

// éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆï¼ˆç”¨äºå•è®¾å¤‡ç™»å½•æ£€æŸ¥ï¼‰
fastify.get('/api/auth/verify-token', async (request, reply) => {
  try {
    const token = request.headers.authorization?.replace('Bearer ', '')
    if (!token) {
      return reply.code(401).send({ success: false, message: 'æœªç™»å½•', valid: false })
    }

    const decoded = jwt.verify(token, JWT_SECRET)

    // æ£€æŸ¥æ•°æ®åº“ä¸­çš„session_tokenæ˜¯å¦åŒ¹é…
    const [users] = await pool.query(
      'SELECT session_token FROM users WHERE id = ?',
      [decoded.id]
    )

    if (users.length === 0) {
      return reply.code(401).send({ success: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨', valid: false })
    }

    const user = users[0]

    // å¦‚æœæ•°æ®åº“ä¸­çš„tokenä¸å½“å‰tokenä¸åŒ¹é…ï¼Œè¯´æ˜ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•äº†
    if (user.session_token !== token) {
      return reply.code(401).send({
        success: false,
        message: 'æ‚¨çš„è´¦å·å·²åœ¨å…¶ä»–è®¾å¤‡ç™»å½•',
        valid: false,
        kicked: true // æ ‡è®°ä¸ºè¢«è¸¢å‡º
      })
    }

    return { success: true, valid: true }
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return reply.code(401).send({ success: false, message: 'Tokenå·²è¿‡æœŸ', valid: false })
    }
    console.error('TokenéªŒè¯å¤±è´¥:', error)
    return reply.code(401).send({ success: false, message: 'Tokenæ— æ•ˆ', valid: false })
  }
})

// è·å–å½“å‰ç”¨æˆ·çš„æƒé™åˆ—è¡¨
fastify.get('/api/auth/permissions', async (request, reply) => {
  try {
    const token = request.headers.authorization?.replace('Bearer ', '')
    if (!token) {
      return reply.code(401).send({ success: false, message: 'æœªç™»å½•' })
    }

    const decoded = jwt.verify(token, JWT_SECRET)

    // è·å–ç”¨æˆ·çš„è§’è‰²å’Œæƒé™
    const [permissions] = await pool.query(`
      SELECT DISTINCT p.code, p.name, p.resource, p.action, p.module
      FROM permissions p
      INNER JOIN role_permissions rp ON p.id = rp.permission_id
      INNER JOIN user_roles ur ON rp.role_id = ur.role_id
      WHERE ur.user_id = ?
    `, [decoded.id])

    // è·å–ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯
    const [roles] = await pool.query(`
      SELECT r.id, r.name, r.can_view_all_departments
      FROM roles r
      INNER JOIN user_roles ur ON r.id = ur.role_id
      WHERE ur.user_id = ?
    `, [decoded.id])

    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    const [user] = await pool.query('SELECT username, department_id FROM users WHERE id = ?', [decoded.id])

    return {
      success: true,
      data: {
        permissions: permissions.map(p => p.code),
        permissionDetails: permissions,
        roles: roles,
        canViewAllDepartments: roles.some(r => r.can_view_all_departments === 1),
        departmentId: user[0]?.department_id
      }
    }
  } catch (error) {
    console.error('è·å–æƒé™å¤±è´¥:', error)
    return reply.code(401).send({ success: false, message: 'è·å–æƒé™å¤±è´¥' })
  }
})

// éªŒè¯ token æ ¡éªŒ
async function verifyToken(request, reply) {
  try {
    const token = request.headers.authorization?.replace('Bearer ', '')
    if (!token) {
      return reply.code(401).send({ success: false, message: 'æœªæä¾›è®¤è¯ä»¤ç‰Œ' })
    }

    const decoded = jwt.verify(token, JWT_SECRET)
    request.user = decoded
  } catch (error) {
    return reply.code(401).send({ success: false, message: 'æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ' })
  }
}

// ==================== å‘˜å·¥ç®¡ç† API ====================

// æ ¹æ®user_idè·å–å‘˜å·¥ä¿¡æ¯
fastify.get('/api/employees/by-user/:userId', async (request, reply) => {
  const { userId } = request.params

  try {
    const [employees] = await pool.query(
      `SELECT e.*, u.real_name, u.username, u.department_id, d.name as department_name
       FROM employees e
       LEFT JOIN users u ON e.user_id = u.id
       LEFT JOIN departments d ON u.department_id = d.id
       WHERE e.user_id = ?`,
      [userId]
    )

    if (employees.length === 0) {
      return reply.code(404).send({
        success: false,
        message: 'æœªæ‰¾åˆ°å‘˜å·¥ä¿¡æ¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ å‘˜å·¥æ¡£æ¡ˆ'
      })
    }

    return {
      success: true,
      data: employees[0]
    }
  } catch (error) {
    console.error('è·å–å‘˜å·¥ä¿¡æ¯å¤±è´¥:', error)
    return reply.code(500).send({ success: false, message: 'è·å–å‘˜å·¥ä¿¡æ¯å¤±è´¥' })
  }
})

// ==================== å®¢æœç®¡ç† API ====================

// è·å–å®¢æœäººå‘˜åˆ—è¡¨
fastify.get('/api/customers', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT
        u.id,
        u.username,
        u.real_name as name,
        u.email,
        u.phone,
        d.name as department,
        u.status,
        e.rating
      FROM users u
      LEFT JOIN employees e ON u.id = e.user_id
      LEFT JOIN departments d ON u.department_id = d.id
      WHERE d.name = 'å®¢æœéƒ¨' OR u.department_id IN (SELECT id FROM departments WHERE name = 'å®¢æœéƒ¨')
      ORDER BY u.created_at DESC
    `)
    return rows
  } catch (error) {
    reply.code(500).send({ error: 'è·å–å®¢æœåˆ—è¡¨å¤±è´¥' })
  }
})

// æ–°å¢å®¢æœäººå‘˜
fastify.post('/api/customers', async (request, reply) => {
  const { name, email, phone, department, status, rating } = request.body

  try {
    // è·å–éƒ¨é—¨ID
    const [deptRows] = await pool.query('SELECT id FROM departments WHERE name = ?', [department])
    const departmentId = deptRows[0]?.id || 6 // é»˜è®¤å®¢æœéƒ¨IDä¸º6

    // ç”Ÿæˆç”¨æˆ·å
    const username = `CS${Date.now()}`
    const passwordHash = '$2b$12$KIXxLQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYqNqYq' // é»˜è®¤å¯†ç : 123456

    // åˆ›å»ºç”¨æˆ·
    const [userResult] = await pool.query(
      'INSERT INTO users (username, password_hash, real_name, email, phone, department_id, status) VALUES (?, ?, ?, ?, ?, ?, ?)',
      [username, passwordHash, name, email, phone, departmentId, status]
    )

    // åˆ›å»ºå‘˜å·¥ä¿¡æ¯
    const employeeNo = `E${String(userResult.insertId).padStart(3, '0')}`
    await pool.query(
      'INSERT INTO employees (user_id, employee_no, position, hire_date, rating, status) VALUES (?, ?, ?, NOW(), ?, ?)',
      [userResult.insertId, employeeNo, 'å®¢æœä¸“å‘˜', rating, status]
    )

    return { success: true, id: userResult.insertId }
  } catch (error) {
    console.error(error)
    reply.code(500).send({ error: 'æ–°å¢å®¢æœå¤±è´¥' })
  }
})

// æ›´æ–°å®¢æœäººå‘˜
fastify.put('/api/customers/:id', async (request, reply) => {
  const { id } = request.params
  const { name, email, phone, department, status, rating } = request.body

  try {
    // è·å–éƒ¨é—¨ID
    const [deptRows] = await pool.query('SELECT id FROM departments WHERE name = ?', [department])
    const departmentId = deptRows[0]?.id || 6

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    await pool.query(
      'UPDATE users SET real_name = ?, email = ?, phone = ?, department_id = ?, status = ? WHERE id = ?',
      [name, email, phone, departmentId, status, id]
    )

    // æ›´æ–°å‘˜å·¥ä¿¡æ¯
    await pool.query(
      'UPDATE employees SET rating = ?, status = ? WHERE user_id = ?',
      [rating, status, id]
    )

    return { success: true }
  } catch (error) {
    console.error(error)
    reply.code(500).send({ error: 'æ›´æ–°å®¢æœå¤±è´¥' })
  }
})

// åˆ é™¤å®¢æœäººå‘˜
fastify.delete('/api/customers/:id', async (request, reply) => {
  const { id } = request.params

  try {
    await pool.query('DELETE FROM users WHERE id = ?', [id])
    return { success: true }
  } catch (error) {
    console.error(error)
    reply.code(500).send({ error: 'åˆ é™¤å®¢æœå¤±è´¥' })
  }
})

// è·å–ä¼šè¯åˆ—è¡¨
fastify.get('/api/sessions', async (request, reply) => {
  try {
    // æ¨¡æ‹Ÿä¼šè¯æ•°æ®ï¼ˆå®é™…åº”è¿æ¥ quality_sessions è¡¨ï¼‰
    const sessions = [
      { id: 1, customer: 'å®¢æˆ·A', agent: 'å®¢æœ', startTime: '2024-11-09 09:00', duration: '15åˆ†é’Ÿ', status: 'completed', satisfaction: 5 },
      { id: 2, customer: 'å®¢æˆ·B', agent: 'å®¢æœ', startTime: '2024-11-09 10:30', duration: '8åˆ†é’Ÿ', status: 'completed', satisfaction: 4 },
      { id: 3, customer: 'å®¢æˆ·C', agent: 'å®¢æœ', startTime: '2024-11-09 11:15', duration: 'æ­£åœ¨é€šè¯', status: 'active', satisfaction: null }
    ];
    return sessions;
  } catch (error) {
    reply.code(500).send({ error: 'è·å–ä¼šè¯åˆ—è¡¨å¤±è´¥' });
  }
})

// è·å–è´¨æ£€è®°å½•
fastify.get('/api/quality-inspections', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT
        qs.id,
        qs.session_id as sessionId,
        u.real_name as agent,
        qs.inspector_name as inspector,
        qs.total_score as score,
        qs.status,
        DATE_FORMAT(qs.created_at, '%Y-%m-%d') as date
      FROM quality_sessions qs
      LEFT JOIN users u ON qs.agent_id = u.id
      ORDER BY qs.created_at DESC
      LIMIT 50
    `);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'è·å–è´¨æ£€åˆ—è¡¨å¤±è´¥' });
  }
});

// æäº¤è´¨æ£€
fastify.post('/api/quality-inspections', async (request, reply) => {
  const { sessionId, scores, comment } = request.body;

  try {
    const totalScore = Math.round(
      scores.attitude * 0.3 +
      scores.professional * 0.3 +
      scores.communication * 0.2 +
      scores.compliance * 0.2
    );

    await pool.query(
      'UPDATE quality_sessions SET status = ?, total_score = ?, inspector_name = ?, comments = ? WHERE id = ?',
      ['completed', totalScore, 'å‰å°äººå‘˜', comment, sessionId]
    );

    return { success: true, score: totalScore };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'æäº¤è´¨æ£€å¤±è´¥' });
  }
})

// ==================== éƒ¨é—¨ç®¡ç† API ====================

// è·å–éƒ¨é—¨åˆ—è¡¨
fastify.get('/api/departments', async (request, reply) => {
  try {
    const { includeDeleted, forManagement } = request.query;
    const { extractUserPermissions } = require('./middleware/checkPermission');

    // è·å–ç”¨æˆ·æƒé™
    const permissions = await extractUserPermissions(request, pool);

    let query = 'SELECT * FROM departments WHERE 1=1';
    const params = [];

    // é»˜è®¤ä¸æ˜¾ç¤ºå·²åˆ é™¤çš„éƒ¨é—¨
    if (includeDeleted !== 'true') {
      query += ' AND status != "deleted"';
    }

    // å¦‚æœæ˜¯ç”¨äºç®¡ç†ç›®çš„ï¼ˆå¦‚é…ç½®è§’è‰²éƒ¨é—¨æƒé™ï¼‰ï¼Œåˆ™è¿”å›æ‰€æœ‰éƒ¨é—¨
    // å¦åˆ™åº”ç”¨æ­£å¸¸çš„æƒé™æ§åˆ¶
    if (forManagement !== 'true') {

      // ä½¿ç”¨éƒ¨é—¨æƒé™é€»è¾‘ï¼šèƒ½çœ‹åˆ°çš„éƒ¨é—¨åªå’Œé…ç½®æœ‰å…³ï¼Œå’Œèº«ä»½æ— å…³
      if (!permissions) {
        // æ²¡æœ‰æƒé™ä¿¡æ¯ï¼ˆæœªç™»å½•æˆ–æ— è§’è‰²ï¼‰ï¼Œä¸æ˜¾ç¤ºä»»ä½•éƒ¨é—¨
        query += ' AND 1=0';
      } else if (permissions.viewableDepartmentIds && permissions.viewableDepartmentIds.length > 0) {
        // æœ‰é…ç½®éƒ¨é—¨æƒé™ï¼Œåªæ˜¾ç¤ºé…ç½®çš„éƒ¨é—¨
        const placeholders = permissions.viewableDepartmentIds.map(() => '?').join(',');
        query += ` AND id IN (${placeholders})`;
        params.push(...permissions.viewableDepartmentIds);
      } else if (permissions.departmentId) {
        // å¦‚æœæ²¡æœ‰é…ç½®éƒ¨é—¨æƒé™ï¼Œä½†æœ‰æ‰€åœ¨éƒ¨é—¨ï¼Œåˆ™æ˜¾ç¤ºè‡ªå·±çš„éƒ¨é—¨
        query += ' AND id = ?';
        params.push(permissions.departmentId);
      } else {
        // æ²¡æœ‰é…ç½®éƒ¨é—¨æƒé™ï¼Œä¹Ÿæ²¡æœ‰æ‰€åœ¨éƒ¨é—¨ï¼Œä¸æ˜¾ç¤ºä»»ä½•éƒ¨é—¨
        query += ' AND 1=0';
      }
    }

    query += ' ORDER BY sort_order, created_at DESC';

    const [rows] = await pool.query(query, params);
    return rows;
  } catch (error) {
    console.error('è·å–éƒ¨é—¨åˆ—è¡¨å¤±è´¥:', error);
    reply.code(500).send({ error: 'è·å–éƒ¨é—¨åˆ—è¡¨å¤±è´¥' });
  }
})

// åˆ›å»ºéƒ¨é—¨
fastify.post('/api/departments', async (request, reply) => {
  const { name, description, status } = request.body;
  try {
    const [result] = await pool.query(
      'INSERT INTO departments (name, description, status) VALUES (?, ?, ?)',
      [name, description, status]
    );
    return { success: true, id: result.insertId };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'åˆ›å»ºéƒ¨é—¨å¤±è´¥' });
  }
});

// æ›´æ–°éƒ¨é—¨
fastify.put('/api/departments/:id', async (request, reply) => {
  const { id } = request.params;
  const { name, description, status } = request.body;
  try {
    // è·å–åŸéƒ¨é—¨çŠ¶æ€
    const [oldDept] = await pool.query('SELECT status FROM departments WHERE id = ?', [id]);
    const oldStatus = oldDept[0]?.status;

    // æ›´æ–°éƒ¨é—¨ä¿¡æ¯
    await pool.query(
      'UPDATE departments SET name = ?, description = ?, status = ? WHERE id = ?',
      [name, description, status, id]
    );

    // æ ¹æ®çŠ¶æ€å˜æ›´åŒæ­¥æ›´æ–°è¯¥éƒ¨é—¨ä¸‹æ‰€æœ‰å‘˜å·¥çŠ¶æ€
    if (oldStatus && oldStatus !== status) {
      // è·å–è¯¥éƒ¨é—¨ä¸‹çš„æ‰€æœ‰å‘˜å·¥
      const [employees] = await pool.query(`
        SELECT e.id, e.user_id
        FROM employees e
        LEFT JOIN users u ON e.user_id = u.id
        WHERE u.department_id = ?
      `, [id]);

      // æ›´æ–°æ‰€æœ‰å‘˜å·¥çŠ¶æ€
      if (employees.length > 0) {
        const employeeStatus = status === 'active' ? 'active' : 'inactive';
        await pool.query(`
          UPDATE employees
          SET status = ?
          WHERE id IN (${employees.map(() => '?').join(',')})
        `, [employeeStatus, ...employees.map(e => e.id)]);
      }
    }

    return {
      success: true,
      affectedEmployees: oldStatus !== status ? (await pool.query(`
        SELECT COUNT(*) as count
        FROM employees e
        LEFT JOIN users u ON e.user_id = u.id
        WHERE u.department_id = ?
      `, [id]))[0][0].count : 0
    };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'æ›´æ–°éƒ¨é—¨å¤±è´¥' });
  }
});

// åˆ é™¤éƒ¨é—¨ï¼ˆè½¯åˆ é™¤ï¼‰
fastify.delete('/api/departments/:id', async (request, reply) => {
  const { id } = request.params;
  try {
    // å°†éƒ¨é—¨çŠ¶æ€è®¾ç½®ä¸º deleted
    await pool.query('UPDATE departments SET status = ? WHERE id = ?', ['deleted', id]);

    // åŒæ—¶å°†è¯¥éƒ¨é—¨ä¸‹çš„æ‰€æœ‰å‘˜å·¥çŠ¶æ€è®¾ç½®ä¸º deleted
    await pool.query(`
      UPDATE employees e
      LEFT JOIN users u ON e.user_id = u.id
      SET e.status = 'deleted'
      WHERE u.department_id = ?
    `, [id]);

    return { success: true, message: 'éƒ¨é—¨åˆ é™¤æˆåŠŸ' };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'åˆ é™¤éƒ¨é—¨å¤±è´¥' });
  }
});

// æ¢å¤éƒ¨é—¨
fastify.post('/api/departments/:id/restore', async (request, reply) => {
  const { id } = request.params;
  try {
    // æ¢å¤éƒ¨é—¨çŠ¶æ€ä¸º active
    await pool.query('UPDATE departments SET status = ? WHERE id = ?', ['active', id]);

    // åŒæ—¶æ¢å¤è¯¥éƒ¨é—¨ä¸‹çš„æ‰€æœ‰å‘˜å·¥çŠ¶æ€ä¸º active
    await pool.query(`
      UPDATE employees e
      LEFT JOIN users u ON e.user_id = u.id
      SET e.status = 'active'
      WHERE u.department_id = ? AND e.status = 'deleted'
    `, [id]);

    return { success: true, message: 'éƒ¨é—¨æ¢å¤æˆåŠŸ' };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'æ¢å¤éƒ¨é—¨å¤±è´¥' });
  }
});

// ==================== èŒä½ç®¡ç† API ====================
// èŒä½ç®¡ç†è·¯ç”±å·²ç§»è‡³ server/routes/positions.js

// ==================== å‘˜å·¥ç®¡ç† API ====================

// è·å–å‘˜å·¥åˆ—è¡¨
fastify.get('/api/employees', async (request, reply) => {
  try {
    const { includeDeleted } = request.query;
    const { extractUserPermissions, applyDepartmentFilter } = require('./middleware/checkPermission');

    // è·å–ç”¨æˆ·æƒé™
    const permissions = await extractUserPermissions(request, pool);

    let query = `
      SELECT
        e.id,
        e.employee_no,
        e.position,
        e.hire_date,
        e.rating,
        e.status,
        e.emergency_contact,
        e.emergency_phone,
        e.address,
        e.education,
        e.skills,
        e.remark,
        u.id as user_id,
        u.username,
        u.real_name,
        u.email,
        u.phone,
        u.avatar,
        u.department_id,
        d.name as department_name
      FROM employees e
      LEFT JOIN users u ON e.user_id = u.id
      LEFT JOIN departments d ON u.department_id = d.id
      WHERE 1=1
    `;

    const params = [];

    // é»˜è®¤ä¸æ˜¾ç¤ºå·²åˆ é™¤çš„å‘˜å·¥
    if (includeDeleted !== 'true') {
      query += ' AND e.status != "deleted"';
    }

    // åº”ç”¨éƒ¨é—¨æƒé™è¿‡æ»¤
    const filtered = applyDepartmentFilter(permissions, query, params, 'u.department_id');
    query = filtered.query;
    const finalParams = filtered.params;

    query += ' ORDER BY e.created_at DESC';

    const [rows] = await pool.query(query, finalParams);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'è·å–å‘˜å·¥åˆ—è¡¨å¤±è´¥' });
  }
});

// åˆ›å»ºå‘˜å·¥
fastify.post('/api/employees', async (request, reply) => {
  const { employee_no, real_name, email, phone, department_id, position, hire_date, rating, status } = request.body;
  try {
    const passwordHash = '$2b$12$KIXxLQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewY5GyYqNqYq'; // é»˜è®¤å¯†ç : 123456

    // ç¡®ä¿å‘˜å·¥ç¼–å·ä½œä¸ºç”¨æˆ·åä½¿ç”¨
    const username = employee_no;

    // å¤„ç†æ—¥æœŸæ ¼å¼ï¼šç¡®ä¿åªä¿å­˜æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
    let formattedHireDate = null;
    if (hire_date) {
      // å¦‚æœæ˜¯ISOæ ¼å¼æˆ–åŒ…å«æ—¶é—´ï¼Œæå–æ—¥æœŸéƒ¨åˆ†
      formattedHireDate = hire_date.split('T')[0];
    } else {
      // å¦‚æœæ²¡æœ‰æä¾›æ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
      formattedHireDate = new Date().toISOString().split('T')[0];
    }

    // åˆ›å»ºç”¨æˆ·
    const [userResult] = await pool.query(
      'INSERT INTO users (username, password_hash, real_name, email, phone, department_id, status) VALUES (?, ?, ?, ?, ?, ?, ?)',
      [username, passwordHash, real_name, email || null, phone || null, department_id || null, 'active']
    );

    // åˆ›å»ºå‘˜å·¥ä¿¡æ¯
    const [employeeResult] = await pool.query(
      'INSERT INTO employees (user_id, employee_no, position, hire_date, rating, status) VALUES (?, ?, ?, ?, ?, ?)',
      [userResult.insertId, employee_no, position || null, formattedHireDate, rating || 3, status]
    );

    // è‡ªåŠ¨åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•ï¼ˆå…¥èŒè®°å½•ï¼‰
    try {
      await pool.query(
        `INSERT INTO employee_changes
        (employee_id, user_id, change_type, change_date, old_department_id, new_department_id, old_position, new_position, reason)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          employeeResult.insertId,
          userResult.insertId,
          'hire',
          formattedHireDate,
          null,
          department_id || null,
          null,
          position || null,
          'æ–°å‘˜å·¥å…¥èŒ'
        ]
      );
    } catch (changeError) {
      console.error('âš ï¸ åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥:', changeError);
      // ä¸å½±å“å‘˜å·¥åˆ›å»ºï¼Œåªè®°å½•é”™è¯¯
    }

    return { success: true, id: userResult.insertId };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'åˆ›å»ºå‘˜å·¥å¤±è´¥' });
  }
});

// æ›´æ–°å‘˜å·¥
fastify.put('/api/employees/:id', async (request, reply) => {
  const { id } = request.params;
  const {
    employee_no, real_name, email, phone, department_id, position,
    hire_date, rating, status, avatar, emergency_contact, emergency_phone,
    address, education, skills, remark
  } = request.body;

  try {
    // è·å–å‘˜å·¥çš„user_id
    const [empRows] = await pool.query('SELECT user_id FROM employees WHERE id = ?', [id]);
    if (empRows.length === 0) {
      return reply.code(404).send({ error: 'å‘˜å·¥ä¸å­˜åœ¨' });
    }
    const userId = empRows[0].user_id;

    // å¤„ç†æ—¥æœŸæ ¼å¼ï¼šç¡®ä¿åªä¿å­˜æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
    let formattedHireDate = null;
    if (hire_date) {
      // å¦‚æœæ˜¯ISOæ ¼å¼æˆ–åŒ…å«æ—¶é—´ï¼Œæå–æ—¥æœŸéƒ¨åˆ†
      formattedHireDate = hire_date.split('T')[0];
    }

    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    await pool.query(
      'UPDATE users SET real_name = ?, email = ?, phone = ?, department_id = ?, avatar = ? WHERE id = ?',
      [real_name, email || null, phone || null, department_id || null, avatar || null, userId]
    );

    // æ›´æ–°å‘˜å·¥ä¿¡æ¯
    await pool.query(
      `UPDATE employees SET
        employee_no = ?,
        position = ?,
        hire_date = ?,
        rating = ?,
        status = ?,
        emergency_contact = ?,
        emergency_phone = ?,
        address = ?,
        education = ?,
        skills = ?,
        remark = ?
      WHERE id = ?`,
      [
        employee_no,
        position || null,
        formattedHireDate,
        rating || 3,
        status,
        emergency_contact || null,
        emergency_phone || null,
        address || null,
        education || null,
        skills || null,
        remark || null,
        id
      ]
    );

    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'æ›´æ–°å‘˜å·¥å¤±è´¥' });
  }
});

// åˆ é™¤å‘˜å·¥ï¼ˆè½¯åˆ é™¤ï¼‰
fastify.delete('/api/employees/:id', async (request, reply) => {
  const { id } = request.params;
  try {
    // å°†å‘˜å·¥çŠ¶æ€è®¾ç½®ä¸º deleted
    await pool.query('UPDATE employees SET status = ? WHERE id = ?', ['deleted', id]);
    return { success: true, message: 'å‘˜å·¥åˆ é™¤æˆåŠŸ' };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'åˆ é™¤å‘˜å·¥å¤±è´¥' });
  }
});

// æ¢å¤å‘˜å·¥
fastify.post('/api/employees/:id/restore', async (request, reply) => {
  const { id } = request.params;
  try {
    // æ¢å¤å‘˜å·¥çŠ¶æ€ä¸º active
    await pool.query('UPDATE employees SET status = ? WHERE id = ?', ['active', id]);
    return { success: true, message: 'å‘˜å·¥æ¢å¤æˆåŠŸ' };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'æ¢å¤å‘˜å·¥å¤±è´¥' });
  }
});

// æ‰¹é‡å¯¼å…¥å‘˜å·¥
fastify.post('/api/employees/batch-import', async (request, reply) => {
  const { employees } = request.body;

  if (!employees || !Array.isArray(employees) || employees.length === 0) {
    return reply.code(400).send({
      success: false,
      message: 'è¯·æä¾›å‘˜å·¥æ•°æ®'
    });
  }

  let successCount = 0;
  let failCount = 0;
  const errors = [];

  for (const emp of employees) {
    try {
      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!emp.employee_no || !emp.real_name || !emp.username || !emp.password || !emp.department_id || !emp.hire_date) {
        errors.push(`${emp.employee_no || 'æœªçŸ¥'}: ç¼ºå°‘å¿…å¡«å­—æ®µ`);
        failCount++;
        continue;
      }

      // æ£€æŸ¥å·¥å·æ˜¯å¦å·²å­˜åœ¨
      const [existingEmp] = await pool.query(
        'SELECT id FROM employees WHERE employee_no = ?',
        [emp.employee_no]
      );

      if (existingEmp.length > 0) {
        errors.push(`${emp.employee_no}: å·¥å·å·²å­˜åœ¨`);
        failCount++;
        continue;
      }

      // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
      const [existingUser] = await pool.query(
        'SELECT id FROM users WHERE username = ?',
        [emp.username]
      );

      if (existingUser.length > 0) {
        errors.push(`${emp.username}: ç”¨æˆ·åå·²å­˜åœ¨`);
        failCount++;
        continue;
      }

      // åŠ å¯†å¯†ç 
      const hashedPassword = await bcrypt.hash(emp.password, 10);

      // å¤„ç†æ—¥æœŸæ ¼å¼ï¼šç¡®ä¿åªä¿å­˜æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
      const formattedHireDate = emp.hire_date.split('T')[0];

      // åˆ›å»ºç”¨æˆ·
      const [userResult] = await pool.query(
        `INSERT INTO users (username, password_hash, real_name, email, phone, department_id, status)
         VALUES (?, ?, ?, ?, ?, ?, ?)`,
        [
          emp.username,
          hashedPassword,
          emp.real_name,
          emp.email,
          emp.phone,
          emp.department_id,
          emp.status || 'active'
        ]
      );

      const userId = userResult.insertId;

      // åˆ›å»ºå‘˜å·¥è®°å½•
      const [employeeResult] = await pool.query(
        `INSERT INTO employees
         (user_id, employee_no, position, hire_date, rating, status,
          emergency_contact, emergency_phone, address, education, skills, remark)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          userId,
          emp.employee_no,
          emp.position,
          formattedHireDate,
          emp.rating || 3,
          emp.status || 'active',
          emp.emergency_contact,
          emp.emergency_phone,
          emp.address,
          emp.education,
          emp.skills,
          emp.remark
        ]
      );

      // è‡ªåŠ¨åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•ï¼ˆå…¥èŒè®°å½•ï¼‰
      try {
        await pool.query(
          `INSERT INTO employee_changes
          (employee_id, user_id, change_type, change_date, old_department_id, new_department_id, old_position, new_position, reason)
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
          [
            employeeResult.insertId,
            userId,
            'hire',
            formattedHireDate,
            null,
            emp.department_id || null,
            null,
            emp.position || null,
            'æ‰¹é‡å¯¼å…¥å…¥èŒ'
          ]
        );
      } catch (changeError) {
        console.error(`âš ï¸ åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥ (${emp.employee_no}):`, changeError);
        // ä¸å½±å“å‘˜å·¥åˆ›å»ºï¼Œåªè®°å½•é”™è¯¯
      }

      successCount++;
    } catch (error) {
      console.error(`å¯¼å…¥å‘˜å·¥å¤±è´¥ (${emp.employee_no}):`, error);
      errors.push(`${emp.employee_no}: ${error.message}`);
      failCount++;
    }
  }

  return {
    success: true,
    message: `å¯¼å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} åï¼Œå¤±è´¥ ${failCount} å`,
    successCount,
    failCount,
    errors: errors.slice(0, 10) // åªè¿”å›å‰10ä¸ªé”™è¯¯
  };
});

// ==================== å‘˜å·¥å®¡æ‰¹ API ====================

// è·å–å¾…å®¡æ‰¹çš„ç”¨æˆ·åˆ—è¡¨
fastify.get('/api/users-pending', async (request, reply) => {
  try {
    // è·å–ç”¨æˆ·æƒé™
    const permissions = await extractUserPermissions(request, pool);

    let query = `
      SELECT
        u.id,
        u.username,
        u.real_name,
        u.email,
        u.phone,
        u.department_id,
        u.created_at,
        d.name as department_name
      FROM users u
      LEFT JOIN departments d ON u.department_id = d.id
      WHERE u.status = 'pending'
    `;

    let params = [];

    // åº”ç”¨éƒ¨é—¨æƒé™è¿‡æ»¤
    const filtered = applyDepartmentFilter(permissions, query, params, 'u.department_id');
    query = filtered.query;
    params = filtered.params;

    query += ' ORDER BY u.created_at DESC';

    const [rows] = await pool.query(query, params);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch pending users' });
  }
});

// æ‰¹å‡†ç”¨æˆ·
fastify.post('/api/users/:id/approve', async (request, reply) => {
  const { id } = request.params;
  const { note } = request.body;

  try {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const [users] = await pool.query(
      'SELECT username, real_name, department_id FROM users WHERE id = ?',
      [id]
    );

    if (users.length === 0) {
      return reply.code(404).send({ error: 'User not found' });
    }

    const user = users[0];

    // æ›´æ–°ç”¨æˆ·çŠ¶æ€ä¸ºactive
    await pool.query(
      'UPDATE users SET status = ?, updated_at = NOW() WHERE id = ?',
      ['active', id]
    );

    // æ£€æŸ¥æ˜¯å¦å·²æœ‰å‘˜å·¥è®°å½•
    const [existingEmployee] = await pool.query(
      'SELECT id FROM employees WHERE user_id = ?',
      [id]
    );

    if (existingEmployee.length === 0) {
      // å¦‚æœæ²¡æœ‰å‘˜å·¥è®°å½•ï¼Œåˆ›å»ºä¸€ä¸ª
      const employeeNo = `E${String(id).padStart(3, '0')}`;
      const hireDate = new Date().toISOString().split('T')[0];

      const [employeeResult] = await pool.query(
        'INSERT INTO employees (user_id, employee_no, hire_date, rating, status) VALUES (?, ?, ?, ?, ?)',
        [id, employeeNo, hireDate, 3, 'active']
      );

      // è‡ªåŠ¨åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•ï¼ˆå…¥èŒè®°å½•ï¼‰
      try {
        await pool.query(
          `INSERT INTO employee_changes
          (employee_id, user_id, change_type, change_date, old_department_id, new_department_id, reason)
          VALUES (?, ?, ?, ?, ?, ?, ?)`,
          [
            employeeResult.insertId,
            id,
            'hire',
            hireDate,
            null,
            user.department_id || null,
            note || 'æ³¨å†Œå®¡æ ¸é€šè¿‡å…¥èŒ'
          ]
        );
      } catch (changeError) {
        console.error('âš ï¸ åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥:', changeError);
        // ä¸å½±å“å®¡æ ¸é€šè¿‡ï¼Œåªè®°å½•é”™è¯¯
      }
    }

    // è®°å½•å®¡æ‰¹æ—¥å¿—
    // await pool.query(
    //   'INSERT INTO approval_logs (user_id, action, note, created_at) VALUES (?, ?, ?, NOW())',
    //   [id, 'approve', note]
    // );

    return { success: true, message: 'Approved successfully' };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Approval failed' });
  }
});

// æ‹’ç»ç”¨æˆ·
fastify.post('/api/users/:id/reject', async (request, reply) => {
  const { id } = request.params;
  const { note } = request.body;

  try {
    await pool.query(
      'UPDATE users SET status = ?, updated_at = NOW() WHERE id = ?',
      ['inactive', id]
    );

    // è®°å½•å®¡æ‰¹æ—¥å¿—
    // await pool.query(
    //   'INSERT INTO approval_logs (user_id, action, note, created_at) VALUES (?, ?, ?, NOW())',
    //   [id, 'reject', note]
    // );

    return { success: true, message: 'Rejected successfully' };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Rejection failed' });
  }
});

// ==================== å‘˜å·¥å˜åŠ¨è®°å½• API ====================

// è·å–å‘˜å·¥å˜åŠ¨è®°å½•
fastify.get('/api/employee-changes', async (request, reply) => {
  const { type } = request.query;

  try {
    // è·å–ç”¨æˆ·æƒé™
    const permissions = await extractUserPermissions(request, pool);

    let query = `
      SELECT
        ec.*,
        u.username,
        u.real_name as real_name,
        e.employee_no,
        d1.name as old_department_name,
        d2.name as new_department_name
      FROM employee_changes ec
      LEFT JOIN users u ON ec.user_id = u.id
      LEFT JOIN employees e ON ec.employee_id = e.id
      LEFT JOIN departments d1 ON ec.old_department_id = d1.id
      LEFT JOIN departments d2 ON ec.new_department_id = d2.id
      WHERE 1=1
    `;

    let params = [];

    // åº”ç”¨éƒ¨é—¨æƒé™è¿‡æ»¤ï¼ˆæ£€æŸ¥æ–°æ—§éƒ¨é—¨ï¼‰
    if (!permissions || !permissions.canViewAllDepartments) {
      if (permissions && permissions.viewableDepartmentIds && permissions.viewableDepartmentIds.length > 0) {
        const placeholders = permissions.viewableDepartmentIds.map(() => '?').join(',');
        query += ` AND (ec.old_department_id IN (${placeholders}) OR ec.new_department_id IN (${placeholders}))`;
        params.push(...permissions.viewableDepartmentIds, ...permissions.viewableDepartmentIds);
      } else {
        query += ` AND 1=0`;
      }
    }

    if (type && type !== 'all') {
      query += ' AND ec.change_type = ?';
      params.push(type);
    }

    query += ' ORDER BY ec.change_date DESC, ec.created_at DESC';

    const [rows] = await pool.query(query, params);

    return rows;
  } catch (error) {
    console.error('è·å–å‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥:', error);
    return reply.code(500).send({ error: 'è·å–å‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥' });
  }
});

// è·å–å‘˜å·¥çš„å˜åŠ¨å†ï¿½?
fastify.get('/api/employee-changes/:employeeId', async (request, reply) => {
  const { employeeId } = request.params;
  try {
    const [rows] = await pool.query(`
      SELECT
        ec.*,
        d1.name as old_department_name,
        d2.name as new_department_name
      FROM employee_changes ec
      LEFT JOIN departments d1 ON ec.old_department_id = d1.id
      LEFT JOIN departments d2 ON ec.new_department_id = d2.id
      WHERE ec.employee_id = ?
      ORDER BY ec.change_date DESC, ec.created_at DESC
    `, [employeeId]);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch employee change history' });
  }
});

// åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•
fastify.post('/api/employee-changes/create', async (request, reply) => {
  const {
    employee_id,
    user_id,
    change_type,
    change_date,
    old_department_id,
    new_department_id,
    old_position,
    new_position,
    reason
  } = request.body;

  try {
    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!employee_id || !user_id || !change_type || !change_date) {
      console.error('ç¼ºå°‘å¿…å¡«å­—æ®µ:', { employee_id, user_id, change_type, change_date });
      return reply.code(400).send({
        error: 'ç¼ºå°‘å¿…å¡«å­—æ®µ',
        details: {
          employee_id: !employee_id ? 'ç¼ºå°‘' : 'æ­£å¸¸',
          user_id: !user_id ? 'ç¼ºå°‘' : 'æ­£å¸¸',
          change_type: !change_type ? 'ç¼ºå°‘' : 'æ­£å¸¸',
          change_date: !change_date ? 'ç¼ºå°‘' : 'æ­£å¸¸'
        }
      });
    }

    // å¤„ç†æ—¥æœŸæ ¼å¼
    const formattedChangeDate = change_date.split('T')[0];

    const [result] = await pool.query(
      `INSERT INTO employee_changes
      (employee_id, user_id, change_type, change_date, old_department_id, new_department_id, old_position, new_position, reason)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        employee_id,
        user_id,
        change_type,
        formattedChangeDate,
        old_department_id || null,
        new_department_id || null,
        old_position || null,
        new_position || null,
        reason || null
      ]
    );
    return { success: true, id: result.insertId };
  } catch (error) {
    console.error('åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥:', error);
    reply.code(500).send({
      error: 'åˆ›å»ºå‘˜å·¥å˜åŠ¨è®°å½•å¤±è´¥',
      message: error.message,
      sqlMessage: error.sqlMessage
    });
  }
});

// ä¿æŒåœ¨æ–‡ä»¶æœ«å°¾è°ƒï¿½?start()

// ==================== çŸ¥è¯†åº“ç®¡ï¿½?API ====================

// è·å–çŸ¥è¯†åº“åˆ†ç±»åˆ—ï¿½?
fastify.get('/api/knowledge/categories', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT * FROM knowledge_categories
      WHERE is_active = 1 AND deleted_at IS NULL
      ORDER BY sort_order, created_at DESC
    `);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch knowledge categories' });
  }
});

// åˆ›å»ºçŸ¥è¯†åº“åˆ†ï¿½?
fastify.post('/api/knowledge/categories', async (request, reply) => {
  const { name, description, icon } = request.body;
  try {
    if (!name) {
      return reply.code(400).send({ error: 'Category name is required' });
    }

    const [result] = await pool.query(
      'INSERT INTO knowledge_categories (name, description, icon) VALUES (?, ?, ?)',
      [name, description || null, icon || 'ğŸ“']
    );

    return { success: true, id: result.insertId };
  } catch (error) {
    console.error('Failed to create knowledge category:', error);
    reply.code(500).send({ error: 'Failed to create knowledge category: ' + error.message });
  }
})

// æ›´æ–°çŸ¥è¯†åº“åˆ†ï¿½?
fastify.put('/api/knowledge/categories/:id', async (request, reply) => {
  const { id } = request.params;
  const { name, description, icon, is_hidden, is_published } = request.body;
  try {
    // æ„å»ºæ›´æ–°è¯­å¥
    const updates = [];
    const values = [];

    if (name !== undefined) {
      updates.push('name = ?');
      values.push(name);
    }
    if (description !== undefined) {
      updates.push('description = ?');
      values.push(description || null);
    }
    if (icon !== undefined) {
      updates.push('icon = ?');
      values.push(icon || 'ğŸ“');
    }
    if (is_hidden !== undefined) {
      updates.push('is_hidden = ?');
      values.push(is_hidden ? 1 : 0);
    }
    if (is_published !== undefined) {
      updates.push('is_published = ?');
      values.push(is_published ? 1 : 0);
    }

    if (updates.length === 0) {
      return reply.code(400).send({ error: 'No updates provided' });
    }

    values.push(id);
    await pool.query(
      `UPDATE knowledge_categories SET ${updates.join(', ')} WHERE id = ?`,
      values
    );
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to update knowledge category' });
  }
});

// åˆ é™¤çŸ¥è¯†åº“åˆ†ï¿½?
fastify.delete('/api/knowledge/categories/:id', async (request, reply) => {
  const { id } = request.params;
  try {
    // å°†å…³è”çš„æ–‡ç« ï¿½?category_id è®¾ç½®ï¿½?NULL
    await pool.query(
      'UPDATE knowledge_articles SET category_id = NULL WHERE category_id = ?',
      [id]
    );

    // åˆ é™¤åˆ†ç±»
    await pool.query('DELETE FROM knowledge_categories WHERE id = ?', [id]);

    return { success: true };
  } catch (error) {
    console.error('Failed to delete knowledge category:', error);
    reply.code(500).send({ error: 'Failed to delete knowledge category' });
  }
});

// åˆ‡æ¢åˆ†ç±»æ˜¾ç¤ºéšè—çŠ¶æ€ï¼ˆåŒæ—¶æ›´æ–°è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰æ–‡æ¡£çŠ¶æ€ï¼‰
fastify.post('/api/knowledge/categories/:id/toggle-visibility', async (request, reply) => {
  const { id } = request.params;
  const { is_hidden } = request.body;

  try {
    // å¼€å§‹äº‹ï¿½?
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // 1. æ›´æ–°åˆ†ç±»çš„éšè—çŠ¶ï¿½?
      await connection.query(
        'UPDATE knowledge_categories SET is_hidden = ? WHERE id = ?',
        [is_hidden ? 1 : 0, id]
      );

      // 2. æ ¹æ®éšè—çŠ¶æ€æ›´æ–°è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰æ–‡æ¡£çŠ¶æ€ä¸º deleted
      // æ˜¾ç¤º(is_hidden=0) -> æ–‡æ¡£çŠ¶æ€æ”¹ï¿½?published
      // éšè—(is_hidden=1) -> æ–‡æ¡£çŠ¶æ€æ”¹ï¿½?archived
      const newArticleStatus = is_hidden ? 'archived' : 'published';
      const [result] = await connection.query(
        'UPDATE knowledge_articles SET status = ? WHERE category_id = ?',
        [newArticleStatus, id]
      );

      // æäº¤äº‹åŠ¡
      await connection.commit();
      connection.release();

      return {
        success: true,
        affectedArticles: result.affectedRows,
        message: is_hidden
          ? `å·²éšè—åˆ†ç±»ï¼Œ${result.affectedRows} ç¯‡æ–‡æ¡£å·²å½’æ¡£`
          : `å·²æ˜¾ç¤ºåˆ†ç±»ï¼Œ${result.affectedRows} ç¯‡æ–‡æ¡£å·²å‘å¸ƒ`
      };
    } catch (error) {
      // å›æ»šäº‹åŠ¡
      await connection.rollback();
      connection.release();
      throw error;
    }
  } catch (error) {
    console.error('åˆ‡æ¢åˆ†ç±»å¯è§æ€§å¤±ï¿½?', error);
    reply.code(500).send({ error: 'Failed to toggle category visibility: ' + error.message });
  }
});



// åˆ›å»ºçŸ¥è¯†æ–‡ç« 
fastify.post('/api/knowledge/articles', async (request, reply) => {
  const { title, category_id, summary, content, type, status, icon, attachments } = request.body;
  try {
    const attachmentsJson = attachments && attachments.length > 0 ? JSON.stringify(attachments) : null;

    const [result] = await pool.query(
      `INSERT INTO knowledge_articles
      (title, category_id, summary, content, attachments, type, status, icon, created_by)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [title, category_id || null, summary || null, content, attachmentsJson, type, status, icon || 'ğŸ“„', request.user?.id || null]
    );
    return { success: true, id: result.insertId };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to create knowledge article' });
  }
});

// æ›´æ–°çŸ¥è¯†æ–‡ç« 
fastify.put('/api/knowledge/articles/:id', async (request, reply) => {
  const { id } = request.params;
  const { title, category_id, summary, content, type, status, icon, attachments } = request.body;
  try {
    // éªŒè¯å¿…è¦å­—æ®µ
    if (!title || title.trim() === '') {
      console.error('Ã— title å­—æ®µä¸ºç©º');
      return reply.code(400).send({ error: 'Title is required' });
    }

    if (!content || content.trim() === '') {
      console.error('Ã— content å­—æ®µä¸ºç©º');
      return reply.code(400).send({ error: 'Content is required' });
    }

    // å¤„ç†é™„ä»¶æ•°æ®
    let attachmentsJson = null;
    if (attachments) {
      if (Array.isArray(attachments)) {
        attachmentsJson = attachments.length > 0 ? JSON.stringify(attachments) : null;
      } else if (typeof attachments === 'string') {
        attachmentsJson = attachments;
      } else {
        console.warn('attachments ç±»å‹ä¸æ­£ï¿½?', typeof attachments, attachments);
        attachmentsJson = JSON.stringify(attachments);
      }
    }

    const result = await pool.query(
      `UPDATE knowledge_articles SET
        title = ?,
        category_id = ?,
        summary = ?,
        content = ?,
        attachments = ?,
        type = ?,
        status = ?,
        icon = ?,
        updated_by = ?
      WHERE id = ?`,
      [title, category_id || null, summary || null, content, attachmentsJson, type, status, icon || 'ğŸ“„', request.user?.id || null, id]
    );
    return { success: true };
  } catch (error) {
    console.error('Failed to update knowledge article:', error);
    console.error('Failed to update knowledge article:', error.message);
    console.error('SQLçŠ¶ï¿½?', error.sqlState);
    console.error('SQLä¿¡æ¯:', error.sqlMessage);
    reply.code(500).send({ error: 'Failed to update knowledge article: ' + error.message });
  }
});

// åˆ é™¤çŸ¥è¯†æ–‡ç« 
fastify.delete('/api/knowledge/articles/:id', async (request, reply) => {
  const { id } = request.params;
  try {
    await pool.query('DELETE FROM knowledge_articles WHERE id = ?', [id]);
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to delete knowledge article' });
  }
});

// ==================== å›æ”¶ï¿½?API ====================

// è½¯åˆ é™¤åˆ†ï¿½?
fastify.post('/api/knowledge/categories/:id/soft-delete', async (request, reply) => {
  const { id } = request.params;
  const userId = request.user?.id || null;

  try {
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // 1. æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜ï¿½?
      const [categories] = await connection.query(
        'SELECT id FROM knowledge_categories WHERE id = ?',
        [id]
      );

      if (categories.length === 0) {
        await connection.rollback();
        connection.release();
        return reply.code(404).send({ error: 'Category not found' });
      }

      // 2. æ›´æ–°åˆ†ç±»çš„éšè—çŠ¶ï¿½?
      await connection.query(
        `UPDATE knowledge_categories
         SET deleted_at = NOW(), deleted_by = ?
         WHERE id = ?`,
        [userId, id]
      );

      // 3. æ ¹æ®éšè—çŠ¶æ€æ›´æ–°è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰æ–‡æ¡£çŠ¶æ€ä¸º deleted
      const [result] = await connection.query(
        `UPDATE knowledge_articles
         SET status = 'deleted', deleted_at = NOW(), deleted_by = ?
         WHERE category_id = ? AND status != 'deleted'`,
        [userId, id]
      );

      await connection.commit();
      connection.release();

      return {
        success: true,
        message: 'Category soft deleted',
        deletedArticles: result.affectedRows
      };
    } catch (error) {
      await connection.rollback();
      connection.release();
      throw error;
    }
  } catch (error) {
    console.error('è½¯åˆ é™¤åˆ†ç±»å¤±ï¿½?', error);
    reply.code(500).send({ error: 'Failed to soft delete category: ' + error.message });
  }
});

// è½¯åˆ é™¤æ–‡ï¿½?
fastify.post('/api/knowledge/articles/:id/soft-delete', async (request, reply) => {
  const { id } = request.params;
  const userId = request.user?.id || null;

  try {
    // æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å­˜ï¿½?
    const [articles] = await pool.query(
      'SELECT id FROM knowledge_articles WHERE id = ?',
      [id]
    );

    if (articles.length === 0) {
      return reply.code(404).send({ error: 'Article not found' });
    }

    await pool.query(
      `UPDATE knowledge_articles
       SET status = 'deleted', deleted_at = NOW(), deleted_by = ?
       WHERE id = ?`,
      [userId, id]
    );

    return {
      success: true,
      message: 'Article soft deleted'
    };
  } catch (error) {
    console.error('è½¯åˆ é™¤æ–‡æ¡£å¤±ï¿½?', error);
    reply.code(500).send({ error: 'Failed to soft delete article: ' + error.message });
  }
});

// è·å–å›æ”¶ç«™ä¸­çš„åˆ†ï¿½?
fastify.get('/api/knowledge/recycle-bin/categories', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT
        kc.*,
        u.real_name as deleted_by_name,
        (SELECT COUNT(*) FROM knowledge_articles WHERE category_id = kc.id AND status = 'deleted') as article_count
      FROM knowledge_categories kc
      LEFT JOIN users u ON kc.deleted_by = u.id
      WHERE kc.deleted_at IS NOT NULL
      ORDER BY kc.deleted_at DESC
    `);

    return {
      success: true,
      data: rows
    };
  } catch (error) {
    console.error('è·å–å›æ”¶ç«™åˆ†ç±»å¤±ï¿½?', error);
    reply.code(500).send({ error: 'Failed to fetch recycle bin categories: ' + error.message });
  }
});

// è·å–å›æ”¶ç«™ä¸­çš„æ–‡ï¿½?
fastify.get('/api/knowledge/recycle-bin/articles', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT
        ka.*,
        kc.name as category_name,
        u1.real_name as author_name,
        u2.real_name as deleted_by_name
      FROM knowledge_articles ka
      LEFT JOIN knowledge_categories kc ON ka.category_id = kc.id
      LEFT JOIN users u1 ON ka.created_by = u1.id
      LEFT JOIN users u2 ON ka.deleted_by = u2.id
      WHERE ka.status = 'deleted'
      ORDER BY ka.deleted_at DESC
    `);

    return {
      success: true,
      data: rows
    };
  } catch (error) {
    console.error('è·å–å›æ”¶ç«™æ–‡æ¡£å¤±ï¿½?', error);
    reply.code(500).send({ error: 'Failed to fetch recycle bin articles: ' + error.message });
  }
});

// æ¢å¤åˆ†ç±»
fastify.post('/api/knowledge/recycle-bin/categories/:id/restore', async (request, reply) => {
  const { id } = request.params;
  const { restoreArticles } = request.body;

  try {
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // 1. æ¢å¤åˆ†ç±»
      await connection.query(
        `UPDATE knowledge_categories
         SET deleted_at = NULL, deleted_by = NULL
         WHERE id = ?`,
        [id]
      );

      let restoredArticles = 0;
      // 2. å¯é€‰ï¼šæ¢å¤è¯¥åˆ†ç±»ä¸‹çš„æ–‡ï¿½?
      if (restoreArticles) {
        const [result] = await connection.query(
          `UPDATE knowledge_articles
           SET status = 'published', deleted_at = NULL, deleted_by = NULL
           WHERE category_id = ? AND status = 'deleted'`,
          [id]
        );
        restoredArticles = result.affectedRows;
      }

      await connection.commit();
      connection.release();

      return {
        success: true,
        message: 'Category restored',
        restoredArticles
      };
    } catch (error) {
      await connection.rollback();
      connection.release();
      throw error;
    }
  } catch (error) {
    console.error('æ¢å¤åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to restore category: ' + error.message });
  }
});

// æ¢å¤æ–‡æ¡£
fastify.post('/api/knowledge/recycle-bin/articles/:id/restore', async (request, reply) => {
  const { id } = request.params;

  try {
    await pool.query(
      `UPDATE knowledge_articles
       SET status = 'published', deleted_at = NULL, deleted_by = NULL
       WHERE id = ?`,
      [id]
    );

    return {
      success: true,
      message: 'Article restored'
    };
  } catch (error) {
    console.error('æ¢å¤æ–‡æ¡£å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to restore article: ' + error.message });
  }
});

// æ°¸ä¹…åˆ é™¤åˆ†ç±»
fastify.delete('/api/knowledge/recycle-bin/categories/:id/permanent', async (request, reply) => {
  const { id } = request.params;

  try {
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // 1. æ°¸ä¹…åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ–‡ï¿½?
      const [result] = await connection.query(
        'DELETE FROM knowledge_articles WHERE category_id = ? AND status = \'deleted\'',
        [id]
      );

      // 2. æ°¸ä¹…åˆ é™¤åˆ†ç±»
      await connection.query(
        'DELETE FROM knowledge_categories WHERE id = ?',
        [id]
      );

      await connection.commit();
      connection.release();

      return {
        success: true,
        message: 'Category permanently deleted',
        deletedArticles: result.affectedRows
      };
    } catch (error) {
      await connection.rollback();
      connection.release();
      throw error;
    }
  } catch (error) {
    console.error('æ°¸ä¹…åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to permanently delete category: ' + error.message });
  }
});

// æ°¸ä¹…åˆ é™¤æ–‡æ¡£
fastify.delete('/api/knowledge/recycle-bin/articles/:id/permanent', async (request, reply) => {
  const { id } = request.params;

  try {
    await pool.query(
      'DELETE FROM knowledge_articles WHERE id = ? AND status = \'deleted\'',
      [id]
    );

    return {
      success: true,
      message: 'Article permanently deleted'
    };
  } catch (error) {
    console.error('æ°¸ä¹…åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to permanently delete article: ' + error.message });
  }
});

// æ¸…ç©ºå›æ”¶ç«™
fastify.post('/api/knowledge/recycle-bin/empty', async (request, reply) => {
  const { type } = request.body; // 'all', 'categories', 'articles'

  try {
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      let deletedCategories = 0;
      let deletedArticles = 0;

      if (type === 'all' || type === 'articles') {
        // åˆ é™¤æ‰€æœ‰å·²åˆ é™¤çš„æ–‡æ¡£
        const [articleResult] = await connection.query(
          'DELETE FROM knowledge_articles WHERE status = \'deleted\''
        );
        deletedArticles = articleResult.affectedRows;
      }

      if (type === 'all' || type === 'categories') {
        // åˆ é™¤æ‰€æœ‰å·²åˆ é™¤çš„åˆ†ç±»
        const [categoryResult] = await connection.query(
          'DELETE FROM knowledge_categories WHERE deleted_at IS NOT NULL'
        );
        deletedCategories = categoryResult.affectedRows;
      }

      await connection.commit();
      connection.release();

      return {
        success: true,
        message: 'Recycle bin emptied',
        deletedCategories,
        deletedArticles
      };
    } catch (error) {
      await connection.rollback();
      connection.release();
      throw error;
    }
  } catch (error) {
    console.error('æ¸…ç©ºå›æ”¶ç«™å¤±è´¥', error);
    reply.code(500).send({ error: 'Failed to empty recycle bin: ' + error.message });
  }
});

// ==================== è€ƒè¯•åˆ†ç±»ç®¡ç† API ====================

// è·å–è€ƒè¯•åˆ†ç±»åˆ—è¡¨
fastify.get('/api/exam-categories', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT
        ec.*,
        COUNT(e.id) as exam_count
      FROM exam_categories ec
      LEFT JOIN exams e ON ec.id = e.category_id
      GROUP BY ec.id
      ORDER BY ec.created_at DESC
    `);
    return rows;
  } catch (error) {
    console.error('è·å–è€ƒè¯•åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'è·å–è€ƒè¯•åˆ†ç±»å¤±è´¥' });
  }
});

// åˆ›å»ºè€ƒè¯•åˆ†ç±»
fastify.post('/api/exam-categories', async (request, reply) => {
  const { name, description, icon } = request.body;

  try {
    const [result] = await pool.query(
      'INSERT INTO exam_categories (name, description, icon) VALUES (?, ?, ?)',
      [name, description || null, icon || 'ğŸ“']
    );
    return { success: true, id: result.insertId };
  } catch (error) {
    console.error('åˆ›å»ºè€ƒè¯•åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'åˆ›å»ºè€ƒè¯•åˆ†ç±»å¤±è´¥' });
  }
});

// æ›´æ–°è€ƒè¯•åˆ†ç±»
fastify.put('/api/exam-categories/:id', async (request, reply) => {
  const { id } = request.params;
  const { name, description, icon } = request.body;

  try {
    await pool.query(
      'UPDATE exam_categories SET name = ?, description = ?, icon = ? WHERE id = ?',
      [name, description || null, icon || 'ğŸ“', id]
    );
    return { success: true };
  } catch (error) {
    console.error('æ›´æ–°è€ƒè¯•åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'æ›´æ–°è€ƒè¯•åˆ†ç±»å¤±è´¥' });
  }
});

// åˆ é™¤è€ƒè¯•åˆ†ç±»
fastify.delete('/api/exam-categories/:id', async (request, reply) => {
  const { id } = request.params;

  try {
    // å°†å…³è”çš„è€ƒè¯•ï¿½?category_id è®¾ç½®ï¿½?NULL
    await pool.query('UPDATE exams SET category_id = NULL WHERE category_id = ?', [id]);

    // åˆ é™¤åˆ†ç±»
    await pool.query('DELETE FROM exam_categories WHERE id = ?', [id]);

    return { success: true };
  } catch (error) {
    console.error('åˆ é™¤è€ƒè¯•åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'åˆ é™¤è€ƒè¯•åˆ†ç±»å¤±è´¥' });
  }
});

// å¢åŠ æ–‡æ¡£æµè§ˆé‡
fastify.post('/api/knowledge/articles/:id/view', async (request, reply) => {
  const { id } = request.params
  try {
    await pool.query('UPDATE knowledge_articles SET view_count = view_count + 1 WHERE id = ?', [id])
    return { success: true }
  } catch (error) {
    console.error(error)
    reply.code(500).send({ error: 'Failed to update view count' })
  }
})

// æ–‡æ¡£ç‚¹èµ
fastify.post('/api/knowledge/articles/:id/like', async (request, reply) => {
  const { id } = request.params;
  const { userId } = request.body; // ä»è¯·æ±‚ä½“è·å–ç”¨æˆ·ID

  try {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµè¿‡
    const [existing] = await pool.query(
      'SELECT id FROM article_likes WHERE article_id = ? AND user_id = ?',
      [id, userId || 'anonymous']
    );

    if (existing.length > 0) {
      return reply.code(400).send({ success: false, message: 'æ‚¨å·²ç»ç‚¹èµè¿‡' });
    }

    // è®°å½•ç‚¹èµ
    await pool.query(
      'INSERT INTO article_likes (article_id, user_id) VALUES (?, ?)',
      [id, userId || 'anonymous']
    );

    // æ›´æ–°ç‚¹èµæ•°
    await pool.query('UPDATE knowledge_articles SET like_count = like_count + 1 WHERE id = ?', [id]);

    return { success: true, message: 'ç‚¹èµæˆåŠŸ' };
  } catch (error) {
    console.error(error);
    // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºè¡¨
    if (error.code === 'ER_NO_SUCH_TABLE') {
      try {
        await pool.query(`
          CREATE TABLE IF NOT EXISTS article_likes (
            id INT PRIMARY KEY AUTO_INCREMENT,
            article_id INT NOT NULL,
            user_id VARCHAR(50) NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            UNIQUE KEY unique_like (article_id, user_id),
            INDEX idx_article (article_id),
            INDEX idx_user (user_id)
          )
        `);
        // é‡è¯•ç‚¹èµ
        return reply.redirect(307, request.url);
      } catch (createError) {
        console.error('åˆ›å»ºç‚¹èµè¡¨å¤±è´¥', createError);
      }
    }
    reply.code(500).send({ error: 'Failed to update like count' });
  }
});

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
fastify.get('/api/knowledge/articles/:id/liked', async (request, reply) => {
  const { id } = request.params;
  const { userId } = request.query;

  try {
    const [existing] = await pool.query(
      'SELECT id FROM article_likes WHERE article_id = ? AND user_id = ?',
      [id, userId || 'anonymous']
    );

    return { liked: existing.length > 0 };
  } catch (error) {
    console.error(error);
    return { liked: false };
  }
});

// æ–‡æ¡£æ”¶è—
fastify.post('/api/knowledge/articles/:id/collect', async (request, reply) => {
  const { id } = request.params;
  const { folder_id, notes } = request.body;
  const userId = request.user?.id || null;

  try {
    // æ£€æŸ¥æ˜¯å¦å·²ç»æ”¶è—è¿‡
    const [existing] = await pool.query(
      'SELECT id FROM article_collections WHERE user_id = ? AND article_id = ?',
      [userId, id]
    );

    if (existing.length > 0) {
      return reply.code(400).send({ success: false, message: 'æ–‡æ¡£å·²åœ¨æ”¶è—å¤¹ä¸­' });
    }

    // æ·»åŠ æ”¶è—è®°å½•
    const [result] = await pool.query(
      'INSERT INTO article_collections (user_id, article_id, folder_id, notes) VALUES (?, ?, ?, ?)',
      [userId, id, folder_id || null, notes || null]
    );

    // æ›´æ–°æ–‡ç« çš„æ”¶è—æ¬¡æ•°
    await pool.query(
      'UPDATE knowledge_articles SET collect_count = collect_count + 1 WHERE id = ?',
      [id]
    );

    return {
      success: true,
      message: 'æ”¶è—æˆåŠŸ',
      id: result.insertId
    };
  } catch (error) {
    console.error('æ”¶è—æ–‡æ¡£å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to collect article' });
  }
});

// è·å–ç”¨æˆ·æ”¶è—çš„æ–‡æ¡£
fastify.get('/api/knowledge/collections', async (request, reply) => {
  try {
    const userId = request.user?.id || null;

    const [rows] = await pool.query(`
      SELECT
        ac.*,
        ka.title,
        ka.summary,
        ka.icon,
        ka.view_count,
        ka.like_count,
        ka.collect_count,
        ka.created_at as article_created_at,
        cf.name as folder_name
      FROM article_collections ac
      LEFT JOIN knowledge_articles ka ON ac.article_id = ka.id
      LEFT JOIN collection_folders cf ON ac.folder_id = cf.id
      WHERE ac.user_id = ?
      ORDER BY ac.created_at DESC
    `, [userId]);

    return {
      success: true,
      data: rows
    };
  } catch (error) {
    console.error('è·å–æ”¶è—æ–‡æ¡£å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to fetch collections' });
  }
});

// å–æ¶ˆæ”¶è—æ–‡æ¡£
fastify.delete('/api/knowledge/articles/:id/uncollect', async (request, reply) => {
  const { id } = request.params;
  const userId = request.user?.id || null;

  try {
    // åˆ é™¤æ”¶è—è®°å½•
    const [result] = await pool.query(
      'DELETE FROM article_collections WHERE user_id = ? AND article_id = ?',
      [userId, id]
    );

    if (result.affectedRows === 0) {
      return reply.code(404).send({ success: false, message: 'æœªæ‰¾åˆ°æ”¶è—è®°å½•' });
    }

    // æ›´æ–°æ–‡ç« çš„æ”¶è—æ¬¡æ•°
    await pool.query(
      'UPDATE knowledge_articles SET collect_count = GREATEST(0, collect_count - 1) WHERE id = ?',
      [id]
    );

    return {
      success: true,
      message: 'å·²å–æ¶ˆæ”¶è—'
    };
  } catch (error) {
    console.error('å–æ¶ˆæ”¶è—å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to uncollect article' });
  }
});

// æ£€æŸ¥æ–‡æ¡£æ˜¯å¦å·²æ”¶è—
fastify.get('/api/knowledge/articles/:id/collected', async (request, reply) => {
  const { id } = request.params;
  const userId = request.user?.id || null;

  try {
    const [existing] = await pool.query(
      'SELECT id, folder_id, notes FROM article_collections WHERE user_id = ? AND article_id = ?',
      [userId, id]
    );

    return {
      collected: existing.length > 0,
      collection: existing[0] || null
    };
  } catch (error) {
    console.error('æ£€æŸ¥æ”¶è—çŠ¶æ€å¤±è´¥:', error);
    return { collected: false };
  }
});

// è·å–æˆ‘çš„åˆ†ç±»ï¼ˆç”¨æˆ·åˆ›å»ºçš„åˆ†ç±»ï¼‰
fastify.get('/api/my-knowledge/categories', async (request, reply) => {
  try {
    // å¦‚æœæ²¡æœ‰ç”¨æˆ·è®¤è¯ï¼Œè¿”å›æ‰€æœ‰åˆ†ç±»
    const userId = request.user?.id || null;

    let query = `
      SELECT * FROM knowledge_categories
      WHERE deleted_at IS NULL
    `;
    const params = [];

    if (userId) {
      query += ` AND created_by = ?`;
      params.push(userId);
    }

    query += ` ORDER BY sort_order, created_at DESC`;

    const [rows] = await pool.query(query, params);
    return rows;
  } catch (error) {
    console.error('è·å–æˆ‘çš„åˆ†ç±»å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to fetch my categories' });
  }
});

// è·å–æˆ‘çš„æ–‡æ¡£ï¼ˆç”¨æˆ·åˆ›å»ºçš„æ–‡æ¡£ï¼‰
fastify.get('/api/my-knowledge/articles', async (request, reply) => {
  try {
    // å¦‚æœæ²¡æœ‰ç”¨æˆ·è®¤è¯ï¼Œè¿”å›æ‰€æœ‰æ–‡æ¡£
    const userId = request.user?.id || null;

    let query = `
      SELECT
        ka.*,
        kc.name as category_name,
        u.real_name as author_name
      FROM knowledge_articles ka
      LEFT JOIN knowledge_categories kc ON ka.category_id = kc.id
      LEFT JOIN users u ON ka.created_by = u.id
      WHERE ka.status != 'deleted'
    `;
    const params = [];

    if (userId) {
      query += ` AND ka.created_by = ?`;
      params.push(userId);
    }

    query += ` ORDER BY ka.created_at DESC`;

    const [rows] = await pool.query(query, params);
    return rows;
  } catch (error) {
    console.error('è·å–æˆ‘çš„æ–‡æ¡£å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to fetch my articles' });
  }
});

// è·å–å•ä¸ªçŸ¥è¯†æ–‡ç« 
fastify.get('/api/knowledge/articles/:id', async (request, reply) => {
  try {
    const { id } = request.params;

    const [rows] = await pool.query(`
      SELECT
        ka.*,
        kc.name as category_name,
        u.real_name as author_name
      FROM knowledge_articles ka
      LEFT JOIN knowledge_categories kc ON ka.category_id = kc.id
      LEFT JOIN users u ON ka.created_by = u.id
      WHERE ka.id = ? AND ka.status != 'deleted'
    `, [id]);

    if (rows.length === 0) {
      return reply.code(404).send({ error: 'Article not found' });
    }

    return rows[0];
  } catch (error) {
    console.error('Failed to fetch knowledge article:', error);
    reply.code(500).send({ error: 'Failed to fetch knowledge article' });
  }
});

// è·å–çŸ¥è¯†æ–‡ç« åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œæœç´¢ï¼‰
fastify.get('/api/knowledge/articles', async (request, reply) => {
  try {
    const { page = 1, pageSize = 20, search = '' } = request.query;
    const offset = (page - 1) * pageSize;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    let whereClause = 'WHERE ka.status != "deleted"';
    const params = [];

    if (search) {
      whereClause += ' AND (ka.title LIKE ? OR ka.summary LIKE ?)';
      params.push(`%${search}%`, `%${search}%`);
    }

    // è·å–æ–‡ç« æ€»æ•°
    const [countResult] = await pool.query(`
      SELECT COUNT(*) as total
      FROM knowledge_articles ka
      ${whereClause}
    `, params);

    const total = countResult[0].total;

    // è·å–åˆ†é¡µæ–‡ç« æ•°æ®
    const [rows] = await pool.query(`
      SELECT
        ka.*,
        kc.name as category_name,
        u.real_name as author_name
      FROM knowledge_articles ka
      LEFT JOIN knowledge_categories kc ON ka.category_id = kc.id
      LEFT JOIN users u ON ka.created_by = u.id
      ${whereClause}
      ORDER BY ka.created_at DESC
      LIMIT ? OFFSET ?
    `, [...params, parseInt(pageSize), parseInt(offset)]);

    return {
      success: true,
      data: rows,
      pagination: {
        page: parseInt(page),
        pageSize: parseInt(pageSize),
        total,
        totalPages: Math.ceil(total / pageSize)
      }
    };
  } catch (error) {
    console.error('è·å–çŸ¥è¯†æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to fetch knowledge articles' });
  }
});

// ä¿å­˜æ–‡æ¡£åˆ°æˆ‘çš„çŸ¥è¯†åº“
fastify.post('/api/my-knowledge/articles/save', async (request, reply) => {
  const { articleId, categoryId, notes } = request.body;
  const userId = request.user?.id || null; // å¦‚æœæ²¡æœ‰ç”¨æˆ·IDï¼Œè®¾ä¸º null è€Œä¸æ˜¯ 'anonymous'

  try {
    // è·å–åŸæ–‡æ¡£
    const [articles] = await pool.query(
      'SELECT * FROM knowledge_articles WHERE id = ?',
      [articleId]
    );

    if (articles.length === 0) {
      return reply.code(404).send({ error: 'Article not found' });
    }

    const originalArticle = articles[0];

    // å¤„ç† attachments å­—æ®µ - ç¡®ä¿æ˜¯æœ‰æ•ˆçš„ JSON å­—ç¬¦ä¸²
    let attachmentsJson = null;
    if (originalArticle.attachments) {
      if (typeof originalArticle.attachments === 'string') {
        // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²ï¼ŒéªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆ JSON
        try {
          JSON.parse(originalArticle.attachments);
          attachmentsJson = originalArticle.attachments;
        } catch (e) {
          console.error('Invalid JSON in attachments:', originalArticle.attachments);
          attachmentsJson = null;
        }
      } else if (typeof originalArticle.attachments === 'object') {
        // å¦‚æœæ˜¯å¯¹è±¡ï¼Œè½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
        attachmentsJson = JSON.stringify(originalArticle.attachments);
      }
    }

    // åˆ›å»ºå‰¯æœ¬åˆ°æˆ‘çš„çŸ¥è¯†åº“
    const [result] = await pool.query(
      `INSERT INTO knowledge_articles
      (title, category_id, summary, content, attachments, type, status, icon, created_by, notes, original_article_id)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
      [
        originalArticle.title,
        categoryId || null,
        originalArticle.summary,
        originalArticle.content,
        attachmentsJson,
        'personal', // ä¿å­˜ä¸ºä¸ªäººçŸ¥è¯†
        'published',
        originalArticle.icon || 'ğŸ“„',
        userId,
        notes || null,
        articleId // è®°å½•åŸæ–‡æ¡£ID
      ]
    );

    return {
      success: true,
      message: 'å·²ä¿å­˜åˆ°æˆ‘çš„çŸ¥è¯†åº“',
      id: result.insertId
    };
  } catch (error) {
    console.error('ä¿å­˜æ–‡æ¡£å¤±è´¥:', error);
    reply.code(500).send({ error: 'Failed to save article' });
  }
});

// é«˜çº§æœç´¢æ–‡æ¡£
fastify.post('/api/knowledge/articles/search', async (request, reply) => {
  try {
    const {
      keyword = '',
      categories = [],
      types = [],
      statuses = [],
      authors = [],
      dateFrom = null,
      dateTo = null,
      sortBy = 'created_at',
      sortOrder = 'DESC',
      page = 1,
      pageSize = 20
    } = request.body;

    let query = `
      SELECT
        ka.*,
        kc.name as category_name,
        u.real_name as author_name
      FROM knowledge_articles ka
      LEFT JOIN knowledge_categories kc ON ka.category_id = kc.id
      LEFT JOIN users u ON ka.created_by = u.id
      WHERE ka.status != 'deleted'
    `;
    const params = [];

    // å…³é”®è¯æœç´¢
    if (keyword && keyword.trim() !== '') {
      query += ` AND (ka.title LIKE ? OR ka.content LIKE ? OR ka.summary LIKE ?)`;
      const keywordParam = `%${keyword}%`;
      params.push(keywordParam, keywordParam, keywordParam);
    }

    // åˆ†ç±»ç­›é€‰
    if (categories && categories.length > 0) {
      query += ` AND ka.category_id IN (${categories.map(() => '?').join(',')})`;
      params.push(...categories);
    }

    // ç±»å‹ç­›é€‰
    if (types && types.length > 0) {
      query += ` AND ka.type IN (${types.map(() => '?').join(',')})`;
      params.push(...types);
    }

    // çŠ¶æ€ç­›é€‰
    if (statuses && statuses.length > 0) {
      query += ` AND ka.status IN (${statuses.map(() => '?').join(',')})`;
      params.push(...statuses);
    }

    // ä½œè€…ç­›é€‰
    if (authors && authors.length > 0) {
      query += ` AND ka.created_by IN (${authors.map(() => '?').join(',')})`;
      params.push(...authors);
    }

    // æ—¥æœŸèŒƒå›´ç­›é€‰
    if (dateFrom) {
      query += ` AND ka.created_at >= ?`;
      params.push(dateFrom);
    }
    if (dateTo) {
      query += ` AND ka.created_at <= ?`;
      params.push(dateTo);
    }

    // æ’åº
    const validSortFields = ['created_at', 'updated_at', 'view_count', 'like_count', 'title'];
    const validSortOrders = ['ASC', 'DESC'];
    const finalSortBy = validSortFields.includes(sortBy) ? sortBy : 'created_at';
    const finalSortOrder = validSortOrders.includes(sortOrder.toUpperCase()) ? sortOrder.toUpperCase() : 'DESC';
    query += ` ORDER BY ka.${finalSortBy} ${finalSortOrder}`;

    // åˆ†é¡µ
    const offset = (page - 1) * pageSize;
    query += ` LIMIT ? OFFSET ?`;
    params.push(pageSize, offset);

    const [rows] = await pool.query(query, params);

    // è·å–æ€»æ•°
    let countQuery = `
      SELECT COUNT(*) as total
      FROM knowledge_articles ka
      WHERE ka.status != 'deleted'
    `;
    const countParams = [];

    if (keyword && keyword.trim() !== '') {
      countQuery += ` AND (ka.title LIKE ? OR ka.content LIKE ? OR ka.summary LIKE ?)`;
      const keywordParam = `%${keyword}%`;
      countParams.push(keywordParam, keywordParam, keywordParam);
    }
    if (categories && categories.length > 0) {
      countQuery += ` AND ka.category_id IN (${categories.map(() => '?').join(',')})`;
      countParams.push(...categories);
    }
    if (types && types.length > 0) {
      countQuery += ` AND ka.type IN (${types.map(() => '?').join(',')})`;
      countParams.push(...types);
    }
    if (statuses && statuses.length > 0) {
      countQuery += ` AND ka.status IN (${statuses.map(() => '?').join(',')})`;
      countParams.push(...statuses);
    }
    if (authors && authors.length > 0) {
      countQuery += ` AND ka.created_by IN (${authors.map(() => '?').join(',')})`;
      countParams.push(...authors);
    }
    if (dateFrom) {
      countQuery += ` AND ka.created_at >= ?`;
      countParams.push(dateFrom);
    }
    if (dateTo) {
      countQuery += ` AND ka.created_at <= ?`;
      countParams.push(dateTo);
    }

    const [countResult] = await pool.query(countQuery, countParams);
    const total = countResult[0].total;

    return {
      success: true,
      data: rows,
      pagination: {
        page,
        pageSize,
        total,
        totalPages: Math.ceil(total / pageSize)
      }
    };
  } catch (error) {
    console.error('æœç´¢å¤±è´¥:', error);
    reply.code(500).send({ error: 'Search failed: ' + error.message });
  }
});

// ==================== æƒé™ç®¡ç† API ====================

// è·å–æ‰€æœ‰è§’è‰²åˆ—è¡¨
fastify.get('/api/roles', async (request, reply) => {
  try {
    const [rows] = await pool.query(`
      SELECT
        r.*,
        COUNT(DISTINCT ur.user_id) as user_count,
        COUNT(DISTINCT rp.permission_id) as permission_count
      FROM roles r
      LEFT JOIN user_roles ur ON r.id = ur.role_id
      LEFT JOIN role_permissions rp ON r.id = rp.role_id
      GROUP BY r.id
      ORDER BY r.level DESC, r.created_at DESC
    `);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch roles' });
  }
});

// åˆ›å»ºè§’è‰²
fastify.post('/api/roles', async (request, reply) => {
  const { name, description, level, can_view_all_departments } = request.body;
  try {
    const [result] = await pool.query(
      'INSERT INTO roles (name, description, level, is_system, can_view_all_departments) VALUES (?, ?, ?, 0, ?)',
      [name, description || null, level || 1, can_view_all_departments || 0]
    );
    return { success: true, id: result.insertId };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to create role' });
  }
});

// æ›´æ–°è§’è‰²
fastify.put('/api/roles/:id', async (request, reply) => {
  const { id } = request.params;
  const { name, description, level, can_view_all_departments } = request.body;
  try {
    // æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿè§’è‰²
    const [roleRows] = await pool.query('SELECT is_system FROM roles WHERE id = ?', [id]);

    if (roleRows.length > 0 && roleRows[0].is_system === 1) {
      // ç³»ç»Ÿè§’è‰²åªå…è®¸ä¿®æ”¹ can_view_all_departments å­—æ®µ
      await pool.query(
        'UPDATE roles SET can_view_all_departments = ? WHERE id = ?',
        [can_view_all_departments || 0, id]
      );
      return { success: true, message: 'ç³»ç»Ÿè§’è‰²åªèƒ½ä¿®æ”¹éƒ¨é—¨æŸ¥çœ‹æƒé™' };
    }

    // éç³»ç»Ÿè§’è‰²å¯ä»¥ä¿®æ”¹æ‰€æœ‰å­—æ®µ
    await pool.query(
      'UPDATE roles SET name = ?, description = ?, level = ?, can_view_all_departments = ? WHERE id = ?',
      [name, description || null, level || 1, can_view_all_departments || 0, id]
    );
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to update role' });
  }
});

// åˆ é™¤è§’è‰²
fastify.delete('/api/roles/:id', async (request, reply) => {
  const { id } = request.params;
  try {
    // æ£€æŸ¥æ˜¯å¦ä¸ºç³»ç»Ÿè§’è‰²
    const [roleRows] = await pool.query('SELECT is_system FROM roles WHERE id = ?', [id]);
    if (roleRows.length > 0 && roleRows[0].is_system === 1) {
      return reply.code(403).send({ error: 'Cannot delete system role' });
    }

    await pool.query('DELETE FROM roles WHERE id = ?', [id]);
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to delete role' });
  }
});

// è·å–æ‰€æœ‰æƒé™åˆ—è¡¨
fastify.get('/api/permissions', async (request, reply) => {
  try {
    const [rows] = await pool.query('SELECT * FROM permissions ORDER BY module, id');
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch permissions' });
  }
});

// è·å–è§’è‰²çš„æƒé™åˆ—è¡¨
fastify.get('/api/roles/:id/permissions', async (request, reply) => {
  const { id } = request.params;
  try {
    const [rows] = await pool.query(`
      SELECT p.*
      FROM permissions p
      INNER JOIN role_permissions rp ON p.id = rp.permission_id
      WHERE rp.role_id = ?
      ORDER BY p.module, p.id
    `, [id]);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch role permissions' });
  }
});

// ä¸ºè§’è‰²æ·»åŠ æƒé™
fastify.post('/api/roles/:id/permissions', async (request, reply) => {
  const { id } = request.params;
  const { permission_id } = request.body;
  try {
    await pool.query(
      'INSERT IGNORE INTO role_permissions (role_id, permission_id) VALUES (?, ?)',
      [id, permission_id]
    );
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to add permission' });
  }
});

// ç§»é™¤è§’è‰²çš„æƒé™
fastify.delete('/api/roles/:roleId/permissions/:permissionId', async (request, reply) => {
  const { roleId, permissionId } = request.params;
  try {
    await pool.query(
      'DELETE FROM role_permissions WHERE role_id = ? AND permission_id = ?',
      [roleId, permissionId]
    );
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to remove permission' });
  }
});

// ==================== è§’è‰²éƒ¨é—¨æƒé™ç®¡ç† API ====================

// è·å–è§’è‰²çš„éƒ¨é—¨æƒé™åˆ—è¡¨
fastify.get('/api/roles/:id/departments', async (request, reply) => {
  const { id } = request.params;
  try {
    const [rows] = await pool.query(`
      SELECT d.*
      FROM departments d
      INNER JOIN role_departments rd ON d.id = rd.department_id
      WHERE rd.role_id = ?
      ORDER BY d.sort_order, d.id
    `, [id]);
    return { success: true, data: rows };
  } catch (error) {
    console.error('è·å–è§’è‰²éƒ¨é—¨æƒé™å¤±è´¥:', error);
    reply.code(500).send({ success: false, error: 'Failed to fetch role departments' });
  }
});

// ä¸ºè§’è‰²æ·»åŠ éƒ¨é—¨æƒé™
fastify.post('/api/roles/:id/departments', async (request, reply) => {
  const { id } = request.params;
  const { department_id } = request.body;
  try {
    await pool.query(
      'INSERT IGNORE INTO role_departments (role_id, department_id) VALUES (?, ?)',
      [id, department_id]
    );
    return { success: true, message: 'éƒ¨é—¨æƒé™æ·»åŠ æˆåŠŸ' };
  } catch (error) {
    console.error('æ·»åŠ è§’è‰²éƒ¨é—¨æƒé™å¤±è´¥:', error);
    reply.code(500).send({ success: false, error: 'Failed to add department permission' });
  }
});

// æ‰¹é‡è®¾ç½®è§’è‰²çš„éƒ¨é—¨æƒé™
fastify.put('/api/roles/:id/departments', async (request, reply) => {
  const { id } = request.params;
  const { department_ids } = request.body; // éƒ¨é—¨IDæ•°ç»„

  try {
    const connection = await pool.getConnection();
    await connection.beginTransaction();

    try {
      // 1. åˆ é™¤è¯¥è§’è‰²çš„æ‰€æœ‰éƒ¨é—¨æƒé™
      await connection.query('DELETE FROM role_departments WHERE role_id = ?', [id]);

      // 2. æ‰¹é‡æ·»åŠ æ–°çš„éƒ¨é—¨æƒé™
      if (department_ids && department_ids.length > 0) {
        const values = department_ids.map(deptId => [id, deptId]);
        await connection.query(
          'INSERT INTO role_departments (role_id, department_id) VALUES ?',
          [values]
        );
      }

      await connection.commit();
      connection.release();

      return {
        success: true,
        message: 'éƒ¨é—¨æƒé™è®¾ç½®æˆåŠŸ',
        count: department_ids?.length || 0
      };
    } catch (error) {
      await connection.rollback();
      connection.release();
      throw error;
    }
  } catch (error) {
    console.error('æ‰¹é‡è®¾ç½®è§’è‰²éƒ¨é—¨æƒé™å¤±è´¥:', error);
    reply.code(500).send({ success: false, error: 'Failed to update department permissions' });
  }
});

// ç§»é™¤è§’è‰²çš„éƒ¨é—¨æƒé™
fastify.delete('/api/roles/:roleId/departments/:departmentId', async (request, reply) => {
  const { roleId, departmentId } = request.params;
  try {
    await pool.query(
      'DELETE FROM role_departments WHERE role_id = ? AND department_id = ?',
      [roleId, departmentId]
    );
    return { success: true, message: 'éƒ¨é—¨æƒé™ç§»é™¤æˆåŠŸ'};
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to remove permission' });
  }
});

// è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆåŒ…å«è§’è‰²ä¿¡æ¯ï¼‰
fastify.get('/api/users-with-roles', async (request, reply) => {
  try {
    // è·å–ç”¨æˆ·æƒé™
    const permissions = await extractUserPermissions(request, pool);

    let query = `
      SELECT
        u.*,
        d.name as department_name
      FROM users u
      LEFT JOIN departments d ON u.department_id = d.id
      WHERE u.status != 'pending'
    `;

    let params = [];

    // åº”ç”¨éƒ¨é—¨æƒé™è¿‡æ»¤
    const filtered = applyDepartmentFilter(permissions, query, params, 'u.department_id');
    query = filtered.query;
    params = filtered.params;

    const [users] = await pool.query(query, params);

    // ä¸ºæ¯ä¸ªç”¨æˆ·è·å–è§’è‰²ä¿¡æ¯
    for (const user of users) {
      const [roles] = await pool.query(`
        SELECT r.id, r.name, r.description, r.level
        FROM roles r
        INNER JOIN user_roles ur ON r.id = ur.role_id
        WHERE ur.user_id = ?
      `, [user.id]);
      user.roles = roles;
    }

    return users;
  } catch (error) {
    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
    return reply.code(500).send({ error: 'è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥' });
  }
});

// è·å–ç”¨æˆ·çš„è§’è‰²åˆ—è¡¨
fastify.get('/api/users/:id/roles', async (request, reply) => {
  const { id } = request.params;
  try {
    const [rows] = await pool.query(`
      SELECT r.*
      FROM roles r
      INNER JOIN user_roles ur ON r.id = ur.role_id
      WHERE ur.user_id = ?
      ORDER BY r.level DESC
    `, [id]);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch user roles' });
  }
});

// ä¸ºç”¨æˆ·åˆ†é…è§’è‰²
fastify.post('/api/users/:id/roles', async (request, reply) => {
  const { id } = request.params;
  const { role_id } = request.body;
  try {
    await pool.query(
      'INSERT IGNORE INTO user_roles (user_id, role_id, assigned_by) VALUES (?, ?, ?)',
      [id, role_id, request.user?.id || null]
    );
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to assign role' });
  }
});

// ç§»é™¤ç”¨æˆ·çš„è§’è‰²
fastify.delete('/api/users/:userId/roles/:roleId', async (request, reply) => {
  const { userId, roleId } = request.params;
  try {
    await pool.query(
      'DELETE FROM user_roles WHERE user_id = ? AND role_id = ?',
      [userId, roleId]
    );
    return { success: true };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to remove role' });
  }
});

// è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼ˆé€šè¿‡è§’è‰²ï¼‰
fastify.get('/api/users/:id/permissions', async (request, reply) => {
  const { id } = request.params;
  try {
    const [rows] = await pool.query(`
      SELECT DISTINCT p.*
      FROM permissions p
      INNER JOIN role_permissions rp ON p.id = rp.permission_id
      INNER JOIN user_roles ur ON rp.role_id = ur.role_id
      WHERE ur.user_id = ?
      ORDER BY p.module, p.id
    `, [id]);
    return rows;
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to fetch user permissions' });
  }
});

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæƒé™
fastify.get('/api/users/:id/has-permission/:code', async (request, reply) => {
  const { id, code } = request.params;
  try {
    const [rows] = await pool.query(`
      SELECT COUNT(*) as count
      FROM permissions p
      INNER JOIN role_permissions rp ON p.id = rp.permission_id
      INNER JOIN user_roles ur ON rp.role_id = ur.role_id
      WHERE ur.user_id = ? AND p.code = ?
    `, [id, code]);
    return { hasPermission: rows[0].count > 0 };
  } catch (error) {
    console.error(error);
    reply.code(500).send({ error: 'Failed to check permission' });
  }
});

// ==================== å¯åŠ¨æœåŠ¡ ====================

// ==================== è€ƒå‹¤ç®¡ç†è·¯ç”± ====================
fastify.register(require('./routes/attendance-clock'));
fastify.register(require('./routes/leave'));
fastify.register(require('./routes/overtime'));
fastify.register(require('./routes/makeup'));
fastify.register(require('./routes/attendance-stats'));
fastify.register(require('./routes/attendance-settings'));
fastify.register(require('./routes/shifts'));
fastify.register(require('./routes/schedules'));
fastify.register(require('./routes/schedule-excel'));
fastify.register(require('./routes/attendance-approval'));

// ==================== å¢å¼ºåŠŸèƒ½è·¯ç”± ====================
fastify.register(require('./routes/export'));
fastify.register(require('./routes/notifications'));
fastify.register(require('./routes/smart-schedule'));

// ==================== èŒä½ç®¡ç†è·¯ç”± ====================
fastify.register(require('./routes/positions'))

// ==================== éƒ¨é—¨ç®¡ç†è·¯ç”± ====================
fastify.register(require('./routes/departments'))

// ==================== è€ƒæ ¸ç³»ç»Ÿè·¯ç”± ====================
fastify.register(require('./routes/exams'))
fastify.register(require('./routes/assessment-plans'))
fastify.register(require('./routes/assessment-results'))

// ==================== å­¦ä¹ ä¸­å¿ƒè·¯ç”± ====================
fastify.register(require('./routes/learning-tasks'))
fastify.register(require('./routes/learning-plans'))
fastify.register(require('./routes/learning-center'))

const start = async () => {
  try {
    await initDatabase();
    await fastify.listen({ port: 3001, host: '0.0.0.0' });
  } catch (err) {
    fastify.log.error(err);
    process.exit(1);
  }
};

start()
