# 转换假期显示和扣减问题修复说明

## 问题描述

用户反馈：
1. 转换假期没有正确显示
2. `conversion_usage_records` 表中没有数据

## 问题根源

### 1. 数据库表缺失
`conversion_usage_records` 表在数据库中不存在，导致：
- 审批请假时无法记录转换假期的使用明细
- 无法追踪每条转换记录的具体使用情况
- `vacation_conversions` 表的 `remaining_days` 字段没有被正确扣减

### 2. 历史数据不一致
- 请假记录 ID=42 已审批，`used_conversion_days=1`
- 但转换记录 ID=9 的 `remaining_days` 仍然是 12（未扣减）
- `conversion_usage_records` 表中没有对应的使用记录

## 修复方案

### 1. 创建缺失的数据库表

创建了 `conversion_usage_records` 表：

```sql
CREATE TABLE IF NOT EXISTS `conversion_usage_records` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '使用记录ID',
  `conversion_id` int NOT NULL COMMENT '转换记录ID，关联vacation_conversions表',
  `leave_record_id` int NOT NULL COMMENT '请假记录ID，关联leave_records表',
  `used_days` decimal(5,2) NOT NULL COMMENT '使用的天数',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_conversion_id` (`conversion_id`),
  KEY `idx_leave_record_id` (`leave_record_id`),
  CONSTRAINT `fk_conversion_usage_conversion` FOREIGN KEY (`conversion_id`)
    REFERENCES `vacation_conversions` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_conversion_usage_leave` FOREIGN KEY (`leave_record_id`)
    REFERENCES `leave_records` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='转换假期使用记录表';
```

### 2. 修复历史数据

对已审批但未正确扣减的请假记录进行修复：

```sql
-- 扣减转换记录的剩余天数
UPDATE vacation_conversions
SET remaining_days = remaining_days - 1
WHERE id = 9;

-- 插入使用记录
INSERT INTO conversion_usage_records
(conversion_id, leave_record_id, used_days)
VALUES (9, 42, 1);
```

## 修复结果

### 数据验证

执行测试脚本 `test_conversion_display.js` 验证结果：

```
转换假期余额:
  总转换天数: 12 天
  已使用天数: 1 天
  剩余天数: 11 天

使用了转换假期的请假记录:
  ID=42, 类型=personal, 总天数=1, 转换天数=1, 状态=approved

请假记录 ID=42 的使用明细:
  明细ID=1, 转换记录ID=9, 使用天数=1, 来源类型=overtime

✅ 所有数据一致性检查通过！
```

### 前端显示

前端已有显示转换假期的代码（`LeaveRecords.jsx` 第 165-169 行）：

```jsx
{record.used_conversion_days > 0 && (
  <span className="ml-2 text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">
    含转换假期 {record.used_conversion_days} 天
  </span>
)}
```

现在会正确显示：**含转换假期 1 天**

## 后端逻辑验证

### 审批流程（`server/routes/leave.js`）

审批请假时的转换假期扣减逻辑（第 200-260 行）：

1. 检查 `used_conversion_days` 是否大于 0
2. 查询可用的转换记录（按创建时间排序，先进先出）
3. 逐个扣减转换记录的 `remaining_days`
4. 插入 `conversion_usage_records` 使用明细
5. 事务提交，确保数据一致性

### API 端点

- **查询转换余额**: `GET /api/vacation/conversion-balance/:employee_id`
  - 返回总转换天数、已使用天数、剩余天数
  - 返回所有转换记录详情

- **查询使用明细**: `GET /api/vacation/conversion-usage/:leave_record_id`
  - 返回指定请假记录的转换假期使用明细

## 数据流程图

```
1. 加班转换假期
   overtime_records (99h)
   → vacation_conversions (12天, remaining=12)

2. 申请请假（使用转换假期）
   leave_records (days=1, used_conversion_days=1, status=pending)

3. 审批通过
   → vacation_conversions (remaining=11)
   → conversion_usage_records (conversion_id=9, leave_record_id=42, used_days=1)

4. 前端显示
   → 转换假期余额: 剩余 11 天
   → 请假记录: 含转换假期 1 天
```

## 注意事项

### 1. 事务处理
审批请假时使用数据库事务，确保：
- 转换记录扣减
- 使用明细插入
- 请假状态更新
三个操作要么全部成功，要么全部回滚

### 2. 先进先出（FIFO）
扣减转换假期时按创建时间排序：
```sql
ORDER BY created_at ASC FOR UPDATE
```

### 3. 余额验证
申请请假时验证转换假期余额：
```javascript
if (usedConversionDays > totalRemaining) {
  return reply.code(400).send({
    success: false,
    message: `转换假期余额不足，当前可用: ${totalRemaining}天`
  });
}
```

### 4. 数据一致性
定期运行测试脚本验证：
- `vacation_conversions.remaining_days` = `converted_days` - SUM(`conversion_usage_records.used_days`)
- 总已使用天数 = SUM(所有使用记录)

## 相关文件

- 数据库迁移: `database/migrations/add_conversion_usage_records.sql`
- 测试脚本: `test_conversion_display.js`
- 后端路由: `server/routes/leave.js`, `server/routes/vacation-conversion.js`
- 前端页面: `src/pages/Attendance/LeaveApply.jsx`, `src/pages/Attendance/LeaveRecords.jsx`

## 修复时间

2025-12-04

## 修复人员

Kiro AI Assistant
